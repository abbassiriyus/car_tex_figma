<!DOCTYPE html>
<html lang="uz">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    body,
    html {
      height: 100%;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .sidebar h2 {
      margin-bottom: 20px;
      font-size: 20px;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul li {
      margin-bottom: 10px;
      cursor: pointer;
      padding: 8px;
      border-radius: 5px;
      transition: 0.3s;
    }

    .sidebar ul li.active,
    .sidebar ul li:hover {
      background: #34495e;
    }

    .sidebar ul li a {
      color: #fff;
      text-decoration: none;
      display: block;
    }

    /* Main content */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #ecf0f1;
    }

    .page.hidden {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    table,
    th,
    td {
      border: 1px solid #ccc;
    }

    th,
    td {
      padding: 8px;
      text-align: left;
    }

    th {
      background: linear-gradient(90deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
    }

    button {
      padding: 6px 12px;
      margin: 2px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #2980b9;
      color: #fff;
      transition: 0.3s;
    }

    button:hover {
      background: #3498db;
    }

    #add-new,
    #add-user-btn {
      margin-bottom: 10px;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      width: 600px;
      max-width: 90%;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
    }

    #images-list img {
      width: 100%;
      height: 100px;
    }

    #images-list {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
    }

    .modal-content button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .modal-content button:hover {
      background: #5a67d8;
    }

    .sub-section {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
#extra-gos-list{
  display: grid;
  grid-template-columns: 1fr 1fr;
}
    .list-item {
         display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-direction: column;
    padding: 8px;
    background: #f9f9f9;
    border-radius: 5px;

    }

    .list-item img {
      max-width: 50px;
      margin-right: 10px;
    }

    .chip {
      display: inline-block;
      background: #e0e0e0;
      padding: 4px 8px;
      border-radius: 12px;
      margin: 2px;
    }

    .chip-risk-1 {
      background: #ffebee;
      color: #c62828;
    }

    .chip-risk-2 {
      background: #fff3e0;
      color: #f57c00;
    }

    .chip-risk-3 {
      background: #e8f5e9;
      color: #2e7d32;
    }

    /* Yangi dizayn qo'shimchalari */
    td img.car-preview {
      width: 90px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      transition: transform 0.2s;
    }

    td img.car-preview:hover {
      transform: scale(1.1);
    }


    .action-btn {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      transition: all 0.2s;
      margin: 0 3px;
    }

    .action-btn i {
      margin-right: 4px;
    }

    .btn-edit {
      background: #f39c12;
    }

    .btn-edit:hover {
      background: #e67e22;
    }

    .btn-delete {
      background: #e74c3c;
    }

    .btn-delete:hover {
      background: #c0392b;
    }

    .btn-view {
      background: #27ae60;
    }

    .btn-view:hover {
      background: #219653;
    }

    #features-table tbody tr {
      transition: background 0.2s;
    }

    #features-table tbody tr:hover {
      background: #f8f9fa;
    }

    #edit-otchot-preview img {
      max-width: 180px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    #add-otchot-form-container {
      position: fixed;
      top: 0px;
      left: 0px;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.164);
    }

    .add-otchot-form_close {
      margin-bottom: 20px;
    }

    #add-otchot-form {
      width: 30%;
      background-color: white;
      padding: 20px;

    }

    /* Modal ichidagi professional dizayn */
    #car-details-modal .modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 20px;
      padding: 0.5rem;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.18);
      border: 1px solid #e2e8f0;
    }

    #car-details-modal h3 {
        font-size: 18px;
    color: #1e293b;
    /* margin-bottom
Shorthand property to set values for the thickness of the margin area. If left is omitted, it is the same as right. If bottom is omitted it is the same as top, if right is omitted it is the same as top. Negative values for margin properties are allowed, but there may be implementation-specific limits..

Widely available across major browsers (Baseline since January 2018)
Learn more

Don't show
: 2rem; */
    font-weight: 700;
    /* text-align: center; */
    letter-spacing: -0.5px;
    padding: 1rem;
    }

    #car-details-modal .sub-section {
      margin: 2.5rem 0;
      padding: 1.8rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      border: 1px solid #f1f5f9;
    }

    #car-details-modal .sub-section h4 {
      font-size: 1.35rem;
      color: #334155;
      margin-bottom: 1.25rem;
      font-weight: 600;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #6366f1;
      display: inline-block;
    }

    /* Kartochkalar (rasmlar, otchotlar, features, risks va boshqalar uchun) */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .card {
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      transition: all 0.28s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid #e2e8f0;
      position: relative;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 16px 40px rgba(99, 102, 241, 0.18);
      border-color: #c7d2fe;
    }

    .card img {
      width: auto;
      height: 34px;
      object-fit: cover;
      border-bottom: 1px solid #f1f5f9;
      margin: 20px;
      margin-bottom: 0px;
    }

    .card-body {
      padding: 1.25rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .card-subtitle {
      font-size: 0.9rem;
      color: #64748b;
      line-height: 1.4;
    }

    .card-actions {
      padding: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      background: #f8fafc;
      border-top: 1px solid #f1f5f9;
    }

    .card-actions button {
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .card-actions .btn-edit {
      background: #f59e0b;
      color: white;
    }

    .card-actions .btn-edit:hover {
      background: #d97706;
      transform: translateY(-2px);
    }

    .card-actions .btn-delete {
      background: #ef4444;
      color: white;
    }

    .card-actions .btn-delete:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    /* Form styleni professional qilish */
    #add-image-form,
    #add-extra-gos-form,
    #add-feature-form,
    #add-otchot-form,
    #add-risk-form {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 14px;
      border: 1px dashed #c7d2fe;
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
      align-items: end;
    }

    #add-otchot-form,
    #add-risk-form {
      /* grid-template-columns: 2fr 1fr 2fr auto; */
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group label {
      font-size: 0.95rem;
      font-weight: 500;
      color: #475569;
    }

    .form-group input,
    .form-group select {
      padding: 0.85rem 1rem;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
      outline: none;
    }

    .form-group button {
      padding: 0.9rem 1.8rem;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    .form-group button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
    }

    /* Mobil moslashuv */
    @media (max-width: 768px) {
      .card-grid {
        grid-template-columns: 1fr;
      }

      #add-image-form,
      #add-otchot-form,
      #add-risk-form {
        grid-template-columns: 1fr;
      }

      .modal-content {
        padding: 1.5rem;
        width: 96%;
      }
    }

    .saleHistory_modal,.saleHistory_modal2 {
      width: 100%;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.521);
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: 23;
      display: flex;
      justify-content: center;
      align-items: center;

    }

    .saleHistory_modal form, .saleHistory_modal2 form {
      max-width: 500px;
      background-color: white;
      padding: 20px;
      width: 100%;
      border-radius: 20px;
      position: relative;
    }

    .saleHistory_modal h1,.saleHistory_modal2 h1 {
      font-size: 23px;
      margin-bottom: 20px;
    }

    .saleHistory_modal form input,.saleHistory_modal2 form input {
      width: 100%;
    }

    .saleHistory_close {
      position: absolute;
      right: 20px;
      top: 20px;
    }
/* ============================= */
/* ===== SECTION WRAPPER ======= */
/* ============================= */

.adminProbeg_section {
  margin-top: 30px;
  padding: 20px;
  background: #f9fafc;
  border-radius: 14px;
}

/* Header */
.adminProbeg_header {
  /* display: flex;
  justify-content: space-between;
  align-items: center; */
  margin-bottom: 20px;
}

.adminProbeg_header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
}

/* Add button */
.btn_addProbeg {
  background: #2563eb;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s ease;
}

.btn_addProbeg:hover {
  background: #1e4ed8;
}

/* ============================= */
/* ===== PROBEG CARDS ========== */
/* ============================= */

.adminProbeg_cards {
  display: grid;
 grid-template-columns: repeat(auto-fill, minmax(173px, 1fr));
  gap: 18px;
}

.adminProbeg_card {
  background: white;
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  transition: 0.25s ease;
}

.adminProbeg_card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.adminProbeg_card h3 {
  margin: 0 0 8px;
  font-size: 16px;
}

.adminProbeg_card p {
  margin: 0;
  font-size: 14px;
  color: #555;
}

/* Buttons */
.adminProbeg_button {
  margin-top: 12px;
  display: flex;
  gap: 10px;
}

.adminProbeg_button button {
  flex: 1;
  padding: 7px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.adminProbeg_button button:first-child {
  background: #3b82f6;
  color: white;
}

.adminProbeg_button button:first-child:hover {
  background: #2563eb;
}

.adminProbeg_button button:last-child {
  background: #ef4444;
  color: white;
}

.adminProbeg_button button:last-child:hover {
  background: #dc2626;
}

/* ============================= */
/* ===== MODAL ================= */
/* ============================= */

.modal_adminProbeg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 15px;
}

/* Modal box */
.modal_box {
  background: white;
  width: 100%;
  max-width: 380px;
  border-radius: 14px;
  padding: 22px;
  animation: scaleIn 0.2s ease;
}

/* Modal header */
.modal_header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.modal_header h3 {
  margin: 0;
  font-size: 18px;
}

.modal_close {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  font-weight: bold;
}

/* Form */
.form_group {
  display: flex;
  flex-direction: column;
  margin-bottom: 12px;
}

.form_group label {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
}

.form_group input {
  padding: 8px 10px;
  border-radius: 7px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  transition: 0.2s;
}

.form_group input:focus {
  outline: none;
  border-color: #3b82f6;
}

/* Save button */
.btn_save {
  width: 100%;
  margin-top: 10px;
  padding: 9px;
  border-radius: 8px;
  border: none;
  background: #10b981;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.btn_save:hover {
  background: #059669;
}

/* ============================= */
/* ===== ANIMATION ============= */
/* ============================= */

@keyframes scaleIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}
.exploitation {
  margin-top: 30px;
}

.exploitation__title {
  font-size: 20px;
  margin-bottom: 15px;
}

.exploitation__add-btn {
  background: #1e88e5;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 15px;
}

.exploitation__cards {
  display: grid;
  gap: 15px;
}

.exploitation__card {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  border-left: 5px solid #1e88e5;
}

.exploitation__card h5 {
  margin: 0 0 10px;
  font-size: 16px;
}

.exploitation__card p {
  margin: 4px 0;
  font-size: 14px;
}

.exploitation__actions {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

.exploitation__btn {
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.exploitation__btn--edit {
  background: #ffa000;
  color: #fff;
}

.exploitation__btn--delete {
  background: #e53935;
  color: #fff;
}

.exploitation__btn--save {
  background: #1e88e5;
  color: #fff;
  width: 100%;
  margin-top: 10px;
}

/* ===== MODAL ===== */

.exploitation__modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.exploitation__modal-content {
  background: #fff;
  width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
  border-radius: 12px;
}

.exploitation__modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.exploitation__close {
  cursor: pointer;
  font-size: 18px;
}

.exploitation__form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.exploitation__field {
  display: flex;
  flex-direction: column;
}

.exploitation__field input,
.exploitation__field textarea {
  padding: 7px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.sub-section_demage {
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
}

#demageAddBtn {
  padding: 10px 20px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 20px;
}

.sub-section_demage_cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.sub-section_demage_card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.demage-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.demage-modal-content {
  background: white;
  width: 90%;
  max-width: 600px;
  border-radius: 12px;
  padding: 24px;
  position: relative;
}

.demage-modal-close {
  position: absolute;
  top: 12px;
  right: 20px;
  font-size: 32px;
  cursor: pointer;
  color: #666;
}

.demage-form input {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.diagnostic-section {
  padding: 24px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  margin-bottom: 32px;
}

.diagnostic-section__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.diagnostic-section__title {
  margin: 0;
  font-size: 1.375rem;
  font-weight: 600;
  color: #212529;
}

.diagnostic-section__cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 24px;
}

.diagnostic-card {
  background: #ffffff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.diagnostic-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 32px rgba(0,0,0,0.14);
}

.diagnostic-card__date {
  padding: 16px 20px 0;
  font-size: 0.875rem;
  color: #6c757d;
}

.diagnostic-card__title {
  padding: 12px 20px;
  margin: 0;
  font-size: 1.125rem;
  font-weight: 600;
}

.diagnostic-card__info {
  padding: 0 20px 16px;
  font-size: 0.95rem;
  color: #495057;
}

.diagnostic-card__actions {
  padding: 16px 20px;
  display: flex;
  gap: 12px;
  border-top: 1px solid #e9ecef;
}

.diagnostic-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.diagnostic-btn--add {
  background: #28a745;
  color: white;
}

.diagnostic-btn--add:hover {
  background: #218838;
}

.diagnostic-btn--save {
  background: #007bff;
  color: white;
}

.diagnostic-btn--save:hover {
  background: #0069d9;
}

.diagnostic-btn--delete {
  background: #dc3545;
  color: white;
}

.diagnostic-btn--delete:hover {
  background: #c82333;
}

.diagnostic-btn--cancel {
  background: #6c757d;
  color: white;
}

.diagnostic-btn--cancel:hover {
  background: #5c636a;
}
.diagnostic-modal-close{
  font-size: 30px;
  position: absolute;
  right: 20px;
}
.sub-section_diagnostic_card{
  margin: 10px;
  padding: 10px;
 
}
.diagnostic-modal {
  position: fixed;
  inset: 0;
  background: white;
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}

.diagnostic-modal.show {
  display: flex;
}

.diagnostic-modal__overlay {
  position: absolute;
  inset: 0;
}

.diagnostic-modal__content {
  background: #ffffff;
  width: 90%;
  max-width: 720px;
  border-radius: 12px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}

.diagnostic-modal__header {
  padding: 20px 28px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.diagnostic-modal__title {
  margin: 0;
  font-size: 1.35rem;
  font-weight: 600;
}

.diagnostic-modal__close {
  font-size: 36px;
  line-height: 1;
  background: none;
  border: none;
  cursor: pointer;
  color: #6c757d;
}

.diagnostic-modal__close:hover {
  color: #212529;
}

.diagnostic-modal__body {
  padding: 28px;
}

.diagnostic-form__group {
  margin-bottom: 22px;
}

.diagnostic-form__label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #495057;
}

.diagnostic-form__input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #ced4da;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.diagnostic-form__input:focus {
  outline: none;
  border-color: #86b7fe;
  box-shadow: 0 0 0 4px rgba(13,110,253,0.15);
}

.auction-section {
  padding: 24px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
}

.auction-section__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.auction-section__title {
  margin: 0;
  font-size: 1.375rem;
  font-weight: 600;
}

.auction-section__cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(196px, 1fr));
  gap: 24px;
}

.auction-card {
  background: #ffffff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  transition: transform 0.25s ease;
}

.auction-card:hover {
  transform: translateY(-6px);
}

.auction-card__image img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}

.auction-card__link {
  padding: 16px;
  text-align: center;
}

.auction-card__link a {
  color: #007bff;
  text-decoration: none;
  font-weight: 500;
}

.auction-card__actions {
  padding: 16px;
  display: flex;
  gap: 12px;
  justify-content: center;
  border-top: 1px solid #e9ecef;
}
/* Modal umumiy (ekran o'rtasida aniq markazlash) */
.auction-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.65);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px); /* yumshoq blur fon */
}

.auction-modal.show {
  display: flex;
}

/* Modal content — ekranning aniq o'rtasida */
.auction-modal__content {
  background: #ffffff;
  width: 92%;
  max-width: 640px;               /* modal kengligi */
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  transform: translateY(30px);    /* boshida pastda turadi */
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
}

/* Ochilganda animatsiya */
.auction-modal.show .auction-modal__content {
  transform: translateY(0);
  opacity: 1;
}

/* Header */
.auction-modal__header {
  padding: 20px 28px;
  background: linear-gradient(to right, #f8fafc, #f1f5f9);
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.auction-modal__title {
  margin: 0;
  font-size: 1.45rem;
  font-weight: 700;
  color: #0f172a;
  letter-spacing: -0.025em;
}

.auction-modal__close {
  font-size: 42px;
  font-weight: 300;
  background: none;
  border: none;
  cursor: pointer;
  color: #64748b;
  transition: color 0.2s, transform 0.2s;
}

.auction-modal__close:hover {
  color: #1e293b;
  transform: rotate(90deg);
}

/* Body (form joylashgan joy) */
.auction-modal__body {
  padding: 32px 36px 28px;
}

/* Form */
.auction-form__group {
  margin-bottom: 26px;
}

.auction-form__label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  font-size: 0.98rem;
  color: #334155;
}

.auction-form__input {
  width: 100%;
  padding: 14px 18px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  font-size: 1.03rem;
  background: #f8fafc;
  transition: all 0.2s ease;
}

.auction-form__input:focus {
  outline: none;
  border-color: #60a5fa;
  background: white;
  box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
}

/* Fayl inputi uchun chiroyli ko'rinish */
.auction-form__input[type="file"] {
  padding: 10px;
  background: #f1f5f9;
  cursor: pointer;
}

/* Actions / footer */
.auction-form__actions,
.auction-modal__footer {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: flex-end;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid #e2e8f0;
}

.auction-btn {
  padding: 12px 32px;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 140px;
  text-align: center;
}

.auction-btn--save {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
}

.auction-btn--save:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
}

.auction-btn--delete {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  border: none;
}

.auction-btn--delete:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-2px);
}

.auction-btn--cancel {
  background: #e2e8f0;
  color: #475569;
  border: none;
}

.auction-btn--cancel:hover {
  background: #cbd5e1;
}

/* Rasm preview */
.auction-form__hint {
  display: block;
  margin-top: 10px;
  font-size: 0.875rem;
  color: #64748b;
}

.auction-form__hint img {
  max-width: 100%;
  border-radius: 10px;
  margin-top: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.yuridik-section {
  margin: 2rem 0;
  padding: 1.5rem;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.yuridik-section h4 {
  margin: 0 0 1rem;
  font-size: 1.3rem;
  color: #1e293b;
  border-bottom: 2px solid #6366f1;
  padding-bottom: 0.5rem;
  display: inline-block;
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.2rem;
}

.yuridik-card {
  background: white;
  border-radius: 12px;
  padding: 1.25rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  transition: all 0.2s;
  border-left: 4px solid #6366f1;
}

.yuridik-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(99,102,241,0.15);
}

.yuridik-card h5 {
  margin: 0 0 0.8rem;
  font-size: 1.15rem;
  color: #1e293b;
}

.yuridik-card p {
  margin: 0.4rem 0;
  font-size: 0.95rem;
  color: #475569;
}

.yuridik-actions {
  margin-top: 1rem;
  display: flex;
  gap: 0.8rem;
}

.btn-add {
  background: #10b981;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  margin-bottom: 1rem;
  transition: 0.2s;
}

.btn-add:hover {
  background: #059669;
}

/* Edit & Delete tugmalari */
.yuridik-actions button {
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 0.9rem;
  cursor: pointer;
  border: none;
  transition: 0.2s;
}

.yuridik-edit-btn {
  background: #f59e0b;
  color: white;
}

.yuridik-edit-btn:hover {
  background: #d97706;
}

.yuridik-delete-btn {
  background: #ef4444;
  color: white;
}

.yuridik-delete-btn:hover {
  background: #dc2626;
}
/* Responsive (mobil uchun) */
@media (max-width: 640px) {
  .auction-modal__content {
    width: 96%;
    max-height: 94vh;
  }

  .auction-modal__body {
    padding: 20px 24px;
  }

  .auction-form__actions {
    flex-direction: column;
    gap: 12px;
  }

  .auction-btn {
    width: 100%;
  }
}

.accordion-container {
  margin-top: 1rem;
}

.accordion-group {
  margin-bottom: 1.2rem;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.accordion-header {
  background: #f1f5f9;
  padding: 14px 20px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s;
}

.accordion-header:hover {
  background: #e2e8f0;
}

.accordion-content {
  display: none;
  padding: 1rem 1.2rem;
  background: white;
}

.accordion-content.show {
     display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.form-actions {
  display: flex;
  gap: 16px;
  justify-content: flex-end;
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e2e8f0;
}

.btn-save {
  background: #3b82f6;
  color: white;
  padding: 12px 32px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

.btn-save:hover {
  background: #2563eb;
}

.btn-cancel {
  background: #e2e8f0;
  color: #475569;
  padding: 12px 32px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

.btn-cancel:hover {
  background: #cbd5e1;
}
.modal-close{
 position: absolute;
    right: 20px;
    font-size: 23px;
    top: 20px;
}
/* Tugmalar va modal stillari oldingi damage bilan bir xil bo‘lishi mumkin, shuning uchun qisqartirdim */
  </style>
</head>

<body>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2>Admin Panel</h2>
      <ul>
        <li class="nav-item active" data-page="home-carousel">Home Carousel</li>
        <li class="nav-item" data-page="users">Users</li>
        <li class="nav-item" data-page="page3">Mashinalar</li>
        <li class="nav-item" data-page="features">Xususiyatlar (Features)</li>
        <li class="nav-item" data-page="legal-risks">Huquqiy Risklar</li>
        <li><a href="/logout" style="color:#e74c3c;">Logout</a></li>
      </ul>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      <div id="home-carousel" class="page">
        <h2>Home Carousel</h2>
        <button id="add-new">Add New</button>
        <table id="carousel-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Icon</th>
              <th>Title</th>
              <th>Text</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Users Page -->
      <div id="users" class="page hidden">
        <h2>Foydalanuvchilar</h2>
        <button id="add-user-btn">Yangi foydalanuvchi qo'shish</button>
        <table id="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ism</th>
              <th>Telefon</th>
              <th>Tasdiqlangan</th>
              <th>Yaratilgan sana</th>
              <th>Amallar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Mashinalar Page (Page 3) -->
      <div id="page3" class="page hidden">
        <h2>Mashinalar</h2>
        <button id="add-car-btn">Yangi mashina qo'shish</button>
        <table id="cars-table">
          <thead>
            <tr>
              <th>Rasm</th>
              <th>Car Name</th>
              <th>VIN</th>
              <th>Gos raqam</th>
              <th>Rang</th>
              <th>Amallar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Features Page (Page 4) -->
      <div id="features" class="page hidden">
        <h2>Xususiyatlar (Features)</h2>
        <button id="add-feature-main-btn">Yangi xususiyat qo'shish</button>
        <table id="features-table">
          <thead>
            <tr>
              <th>Rasm</th>
              <th>Sarlavha</th>
              <th>Tartib raqami</th>
              <th>Amallar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>


        <button id="add-otchot-main-btn" style="margin-top: 20px;">Yangi asosiy otchot</button>
        <table id="otchot-table">
          <thead>
            <tr>
              <th>Rasm</th>
              <th>Sarlavha</th>
              <th>Tartib raqami</th>
              <th>Amallar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="add-otchot-form-container" style="display:none; width: 100%;">
          <form id="add-otchot-form" style="width:100%" enctype="multipart/form-data">
            <div onclick="document.querySelector('#add-otchot-form-container').style.display='none'"
              class="add-otchot-form_close">✕</div>
            <input type="text" name="title" placeholder="Title" required>
            <label>Tartib raqami:</label>
            <input type="number" name="order" min="0" value="0" required> <!-- ← yangi -->
            <input type="file" name="icon" accept="image/*" required>
            <button type="submit">Qo‘shish</button>
          </form>
        </div>
        <!-- Otchot tahrirlash modali -->
        <div id="edit-otchot-modal" class="modal hidden">
          <div class="modal-content">
            <span class="close" onclick="document.getElementById('edit-otchot-modal').classList.add('hidden')">×</span>
            <h3>Otchotni tahrirlash</h3>

            <form id="edit-otchot-form">
              <input type="hidden" name="id" id="edit-otchot-id">

              <label>Sarlavha:</label>
              <input type="text" name="title" id="edit-otchot-title" required>

              <label>Tartib raqami:</label>
              <input type="number" name="order" id="edit-otchot-order" min="0" required> <!-- ← yangi -->

              <label>Icon (agar yangilash kerak bo‘lsa tanlang):</label>
              <input type="file" name="icon" id="edit-otchot-icon" accept="image/*">

              <div id="edit-otchot-preview" style="margin:10px 0; text-align:center;"></div>

              <button type="submit">Saqlash</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Legal Risks Page (Page 5) -->
      <div id="legal-risks" class="page hidden">
        <h2>Huquqiy Risklar</h2>
        <button id="add-risk-main-btn">Yangi risk qo'shish</button>
        <table id="risks-table">
          <thead>
            <tr>
              <th>Sarlavha</th>
              <th>Matn</th>
              <th>Tartib raqami</th>
              <th>Amallar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </main>
  </div>

  <!-- Add New Carousel Modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <span id="close-modal" class="close">×</span>
      <h3>Yangi Carousel qo'shish</h3>
      <form id="modal-form" enctype="multipart/form-data">
        <label>Image:</label>
        <input type="file" name="image" required>
        <label>Icon:</label>
        <input type="file" name="icon" required>
        <label>Title:</label>
        <input type="text" name="title" required>
        <label>Text:</label>
        <textarea name="text" rows="3" required></textarea>
        <label>Order:</label>
        <input type="number" name="order" value="0" required min="0">
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>

  <!-- Edit Carousel Modal (agar kerak bo'lsa, qayta qo'shish mumkin) -->
  <div id="edit-modal" class="modal hidden">
    <div class="modal-content">
      <span id="close-edit-modal" class="close">×</span>
      <h3>Carouselni</h3>
      <form id="edit-modal-form" enctype="multipart/form-data">
        <input type="hidden" name="id">
        <label>Image (yangilash uchun tanlang):</label>
        <input type="file" name="image">
        <label>Icon (yangilash uchun tanlang):</label>
        <input type="file" name="icon">
        <label>Title:</label>
        <input type="text" name="title" required>
        <label>Text:</label>
        <textarea name="text" rows="3" required></textarea>
        <label>Order:</label>
        <input type="number" name="order" required min="0">
        <button type="submit">Yangilash</button>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="add-user-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="close-add-user">×</span>
      <h3>Yangi foydalanuvchi qo'shish</h3>
      <form id="add-user-form">
        <label>Ism:</label>
        <input type="text" name="name" required>
        <label>Telefon raqam:</label>
        <input type="text" name="phone" required placeholder="+998901234567">
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="edit-user-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="close-edit-user">×</span>
      <h3>Foydalanuvchini</h3>
      <form id="edit-user-form">
        <input type="hidden" name="id">
        <label>Ism:</label>
        <input type="text" name="name" required>
        <label>Telefon raqam:</label>
        <input type="text" name="phone" required>
        <button type="submit">Yangilash</button>
      </form>
    </div>
  </div>

  <!-- Add/Edit Car Modal -->
  <div id="car-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="close-car-modal">×</span>
      <h3 id="car-modal-title">Yangi mashina qo'shish</h3>
      <form id="car-form">
        <input type="hidden" name="id">
        <label>Car Name:</label>
        <input type="text" name="carName" required>
        <label>VIN:</label>
        <input type="text" name="vin" required>
        <label>Gos raqam:</label>
        <input type="text" name="gosNumber" required>
        <label>Dvigatel raqami:</label>
        <input type="text" name="engineNumber" required>
        <label>STS raqami:</label>
        <input type="text" name="stsNumber" required>
        <label>Mashina turi:</label>
        <input type="text" name="carType" required>
        <label>Rang:</label>
        <input type="text" name="color" required>
        <label>Dvigatel:</label>
        <input type="text" name="engine" required>
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>

  <!-- Car Details Modal -->
  <div id="car-details-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="close-car-details">×</span>
      <h3 id="car-details-title">Mashina tafsilotlari</h3>
      <input type="hidden" id="current-car-id">

      <!-- Rasmlar bo‘limi – eng ko‘p o‘zgartirilgan joy -->
      <div class="sub-section">
        <h4>Rasmlar</h4>
        <div id="images-list"></div>

        <!-- Yangi rasm qo‘shish formasi – ixcham va chiroyli -->
        <form id="add-image-form" enctype="multipart/form-data"
          style="margin-top:1.8rem; display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">
          <div style="flex:1; min-width:220px;">
            <label>Rasm yuklash</label>
            <input type="file" name="image" accept="image/*" required>
          </div>
          <div style="flex:1; min-width:200px;">
            <label>Label (masalan: orqa bamper)</label>
            <input type="text" name="label" placeholder="ixtiyoriy label">
          </div>
          <div style="flex-basis:100%; margin:8px 0;">
            <label style="display:flex; align-items:center; gap:10px; font-size:14px; color:#475569; cursor:pointer;">
              <input type="checkbox" name="isDamaged"> Ushbu rasm zararlangan deb belgilash
            </label>
          </div>
          <button type="submit" style="padding:12px 32px; font-size:15px; min-width:160px;">
            Rasm qo‘shish
          </button>
        </form>
      </div>

      <!-- Qolgan bo‘limlar (extra gos, features, legal risks) o‘zgarmagan holda qoladi -->
      <div class="sub-section">
        <h4>Qo‘shimcha Gos raqamlar</h4>
        <div id="extra-gos-list"></div>
        <form id="add-extra-gos-form">
          <label>Yangi raqam:</label>
          <input type="text" name="number" required>
          <button type="submit">Qo‘shish</button>
        </form>
      </div>

      <div class="sub-section">
        <h4>Xususiyatlar</h4>
        <div id="features-list" style="display: grid;grid-template-columns: 1fr 1fr;gap:10px"></div>
        <form id="add-feature-form">
          <label>Xususiyat tanlang:</label>
          <select name="featureId" id="feature-select" required></select>
          <label>Matn:</label>
          <input type="text" name="text">
          <button type="submit">Qo‘shish</button>
        </form>
      </div>
      <!-- OTCHOT EDIT MODAL -->
      <div id="edit-otchot-modal1"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;z-index: 99;">
        <div style="background:#fff; padding:24px; width:400px; border-radius:8px; position:relative;">

          <h3>Otchotni tahrirlash</h3>

          <input type="hidden" id="edit-car-id">
          <input type="hidden" id="edit-otchot-id1">

          <div style="margin-top:12px;">
            <label>Pozitsiya</label>
            <input type="number" id="edit-position" min="1" max="4" style="width:100%; padding:6px;">
          </div>

          <div style="margin-top:12px;">
            <label>Text</label>
            <input type="text" id="edit-text" style="width:100%; padding:6px;">
          </div>

          <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeEditModal()">Bekor qilish</button>
            <button onclick="saveOtchotEdit()">Saqlash</button>
          </div>

        </div>
      </div>

      <div id="otchots-list"></div>
      <form id="add-otchot-form2" style="display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end;width: 100%;">

        <input type="hidden" id="currentCarId">

        <div style="flex:1; min-width:200px;">
          <label>Otchot tanlang</label>
          <select name="otchotId" required id="otchot-select">
            <!-- Otchotlar JS orqali yuklanadi -->
          </select>
        </div>

        <div style="flex:1; min-width:100px;">
          <label>Pozitsiya (1-4)</label>
          <input type="number" name="position" min="1" max="4" required>
        </div>

        <div style="flex:1; min-width:200px;">
          <label>Text (ixtiyoriy)</label>
          <input type="text" name="text" placeholder="Qo‘shimcha matn">
        </div>

        <button type="submit" style="padding:10px 20px;">Otchot qo‘shish</button>
      </form>

      <div class="sub-section">
        <h4>Huquqiy risklar</h4>
        <div id="risks-list"></div>
        <form id="add-risk-form">
          <label>Risk tanlang:</label>
          <select name="riskId" id="risk-select" required></select>
          <label>Pozitsiya (1-3):</label>
          <input type="number" name="position" min="1" max="3" required>
          <button type="submit">Qo‘shish</button>
        </form>
      </div>
      <div class="sub-section">
          <h4>Sotuv amaliyotlari</h4>
        <button id="openModalBtn_Sale" onclick="document.querySelector('.saleHistory_modal').style='display:flex'"
          style="margin-top: 10px;">Sotuv tarixi</button>
        <div class="saleHistory_cards">
          <table>
            <tbody>
              <tr>
                <th>1</th>
                <td>2</td>
              </tr>
              <tr>
                <th>1</th>
                <td>2</td>
              </tr>
              <tr>
                <th>1</th>
                <td>2</td>
              </tr>
              <tr><td><button>Yangilash</button></td><td><button>O`chirish</button></td></tr>
            </tbody>
          </table>
          <table>
            <tbody>
              <tr>
                <th>1</th>
                <td>2</td>
              </tr>
              <tr>
                <th>1</th>
                <td>2</td>
              </tr>
              <tr>
                <th>1</th>
                <td>2</td>
              </tr>
               <tr><td><button>Yangilash</button></td><td><button>O`chirish</button></td></tr>
            </tbody>
          </table>
        </div>
        <div class="saleHistory_modal" style="display: none;">
          <form action="">
            <div class="saleHistory_close" onclick="document.querySelector('.saleHistory_modal').style='display:none'">✕
            </div>
            <h1>Sotuv tarixi yaratish</h1>
            <label for="saleHistory_date">Sanasi</label><br>
            <input type="date" name="saleHistory_date"><br>
            <label for="saleHistory_title">Title</label><br>
            <input type="text" name="saleHistory_title"><br>
            <label for="saleHistory_price">Narxi</label><br>
            <input type="number" name="saleHistory_price"><br>
            <label for="saleHistory_priceOLd">Narxi tushishi</label><br>
            <input type="number" value="0" min="0" name="saleHistory_priceOld"><br>
            <label for="saleHistory_probeg">Probeg</label><br>
            <input type="number" value="0" min="0" name="saleHistory_probeg"><br>
            <label for="saleHistory_shaxar">Shaxar</label><br>
            <input type="text" name="saleHistory_shaxar"><br>
            <label for="saleHistory_holati">Holati</label><br>
            <input type="text" name="saleHistory_holati"><br>
            <label for="saleHistory_link">Link</label><br>
            <input type="text" name="saleHistory_link"><br>
            <button type="button" id="saleHistory_submit">Yuborish</button>
          </form>
        </div>

       <div class="saleHistory_modal2" style="display: none;" >
          <form action="">
            <div class="saleHistory_close" onclick="document.querySelector('.saleHistory_modal2').style='display:none'">✕
            </div>
            <h1>Sotuv tarixi yangilash</h1>
            <label for="saleHistory_date2">Sanasi</label><br>
            <input type="date" name="saleHistory_date2"><br>
            <label for="saleHistory_title2">Title</label><br>
            <input type="text" name="saleHistory_title2"><br>
            <label for="saleHistory_price2">Narxi</label><br>
            <input type="number" name="saleHistory_price2"><br>
            <label for="saleHistory_priceOLd2">Narxi tushishi</label><br>
            <input type="number" value="0" min="0" name="saleHistory_priceOld2"><br>
            <label for="saleHistory_probeg2">Probeg</label><br>
            <input type="number" value="0" min="0" name="saleHistory_probeg2"><br>
            <label for="saleHistory_shaxar2">Shaxar</label><br>
            <input type="text" name="saleHistory_shaxar2"><br>
            <label for="saleHistory_holati2">Holati</label><br>
            <input type="text" name="saleHistory_holati2"><br>
            <label for="saleHistory_link2">Link</label><br>
            <input type="text" name="saleHistory_link2"><br>
            <button type="button" id="saleHistory_submit2">Yuborish</button>
          </form>
        </div>
      </div>
       <div class="sub-section" >
  <h4>Narxlar tafovuti</h4>
  <div class="adminNarx">
<div class="valuation-form-container" style="max-width: 600px; margin: 2rem auto; padding: 2rem; background: #f8fafc; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">


  <form id="valuationForm">
    <!-- Pastki chegara -->
    <div class="form-group">
      <label for="valuationLow">Pastki chegara (Do ...)</label>
      <input 
        type="number" 
        id="valuationLow" 
        name="valuationLow" 
        placeholder="Masalan: 1878677000" 
        min="0" 
        step="10000"
      >
    </div>

    <!-- Oralig‘ pastki -->
    <div class="form-group">
      <label for="valuationRangeLow">Bizning baho oralig‘i (pastki)</label>
      <input 
        type="number" 
        id="valuationRangeLow" 
        name="valuationRangeLow" 
        placeholder="Masalan: 1878677000" 
        min="0" 
        step="10000"
      >
    </div>

    <!-- Oralig‘ yuqori -->
    <div class="form-group">
      <label for="valuationRangeHigh">Bizning baho oralig‘i (yuqori)</label>
      <input 
        type="number" 
        id="valuationRangeHigh" 
        name="valuationRangeHigh" 
        placeholder="Masalan: 2140000000" 
        min="0" 
        step="10000"
      >
    </div>

    <!-- Yuqori chegara -->
    <div class="form-group">
      <label for="valuationHigh">Yuqori chegara (Ot ...)</label>
      <input 
        type="number" 
        id="valuationHigh" 
        name="valuationHigh" 
        placeholder="Masalan: 2600000000" 
        min="0" 
        step="10000"
      >
    </div>

    <!-- Valyuta -->
    <div class="form-group">
      <label for="currency">Valyuta</label>
      <select id="currency" name="currency">
        <option value="UZS">UZS (so‘m)</option>
        <option value="USD">USD (dollar)</option>
      </select>
    </div>

    <!-- Tugmalar -->
    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
      <button type="submit" class="submit-btn" id="saveBtn">
        Saqlash / Yangilash
      </button>
      <button type="button" class="clear-btn" id="clearBtn">
        Tozalash
      </button>
    </div>
  </form>
</div>
  </div>
      </div>


<section class="adminProbeg_section sub-section">

  <div class="adminProbeg_header">
    <h2>Probeg tarixi</h2>
    <button type="button" class="btn_addProbeg" onclick="openPostModal()">
      + Qo‘shish
    </button>
  </div>

  <!-- Cards render bo‘ladigan joy -->
  <div class="adminProbeg_cards" id="adminProbeg_cards">
    <!-- JS orqali to‘ldiriladi -->
  </div>

</section>



<!-- ========================= -->
<!-- ===== POST MODAL ======== -->
<!-- ========================= -->

<div class="modal_adminProbeg modal_adminProbeg_post">

  <div class="modal_box">

    <div class="modal_header">
      <h3>Yangi probeg qo‘shish</h3>
      <span class="modal_close" onclick="closeModals()">✕</span>
    </div>

    <form id="probegPostForm">

      <label>Yil</label>
      <input type="number" name="year" min="1900" max="2100" required>

      <label>Kilometr</label>
      <input type="number" name="kilometer" min="0" required>

      <button type="submit">Saqlash</button>

    </form>

  </div>

</div>


<!-- ========================= -->
<!-- ===== PUT MODAL ========= -->
<!-- ========================= -->

<div class="modal_adminProbeg modal_adminProbeg_put">

  <div class="modal_box">

    <div class="modal_header">
      <h3>Probegni yangilash</h3>
      <span class="modal_close" onclick="closeModals()">✕</span>
    </div>

    <form id="probegPutForm">

      <input type="hidden" name="probegId" class="probegId">

      <label>Yil</label>
      <input type="number" id="putYear" name="year" min="1900" max="2100" required>

      <label>Kilometr</label>
      <input type="number"  id="putKilometer" name="kilometer" min="0" required>

      <button type="submit">Saqlash</button>

    </form>

  </div>

</div>


<div class="sub-section exploitation">

  <h4 class="exploitation__title">Exploitation mashina</h4>

  <!-- ADD BUTTON -->
  <button class="exploitation__add-btn" onclick="openExploitationPost()">
    + Qo‘shish
  </button>

  <!-- CARDS CONTAINER -->  
  <div class="exploitation__cards" id="exploitationCards">
   <div class="exploitation__card">
  <h5>Taxi xizmat</h5>
  <p><b>Davr:</b> 2022-01-01 - 2023-05-01</p>
  <p><b>Kilometr:</b> 10 000 → 45 000</p>
  <p><b>Joy:</b> Toshkent</p>

  <div class="exploitation__actions">
    <button class="exploitation__btn exploitation__btn--edit">Edit</button>
    <button class="exploitation__btn exploitation__btn--delete">Delete</button>
  </div>
</div>
<div class="exploitation__card">
  <h5>Taxi xizmat</h5>
  <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Minima in ullam ipsum voluptates, sint consequuntur.</p>
  <p><b>Davr:</b> 2022-01-01 - 2023-05-01</p>
  <p><b>Kilometr:</b> 10 000 → 45 000</p>
  <p><b>Joy:</b> Toshkent</p>

  <div class="exploitation__actions">
    <button class="exploitation__btn exploitation__btn--edit">Edit</button>
    <button class="exploitation__btn exploitation__btn--delete">Delete</button>
  </div>
</div>

  </div>
<!-- ================= POST MODAL ================= -->
<div class="exploitation__modal exploitation__modal--post" id="exploitationPostModal">
  <div class="exploitation__modal-content">

    <div class="exploitation__modal-header">
      <h3>Exploitation qo‘shish</h3>
      <span onclick="document.querySelector('#exploitationPostModal').style='display:none'" class="exploitation__close">✕</span>
    </div>

    <form id="exploitationPostForm" class="exploitation__form">

      <div class="exploitation__field">
        <label>Boshlanish sana</label>
        <input type="date" name="startDate" required>
      </div>

      <div class="exploitation__field">
        <label>Tugash sana</label>
        <input type="date" name="endDate">
      </div>

      <div class="exploitation__field">
        <label>Boshlang‘ich km</label>
        <input type="number" name="startKilometer">
      </div>

      <div class="exploitation__field">
        <label>Oxirgi km</label>
        <input type="number" name="endKilometer">
      </div>

      <div class="exploitation__field">
        <label>Nomi</label>
        <input type="text" name="title" required>
      </div>

      <div class="exploitation__field">
        <label>Joylashuv</label>
        <input type="text" name="location">
      </div>

      <div class="exploitation__field">
        <label>Tavsif</label>
        <textarea name="description"></textarea>
      </div>

      <button type="submit" class="exploitation__btn exploitation__btn--save">
        Saqlash
      </button>

    </form>
  </div>
</div>


<!-- ================= PUT MODAL ================= -->
<div class="exploitation__modal exploitation__modal--put" id="exploitationPutModal">
  <div class="exploitation__modal-content">

    <div class="exploitation__modal-header">
      <h3>Exploitation yangilash</h3>
      <span onclick="closeExploitationModal()" class="exploitation__close">✕</span>
    </div>

    <form id="exploitationPutForm" class="exploitation__form">

      <input type="hidden" name="exploitationId">

      <div class="exploitation__field">
        <label>Boshlanish sana</label>
        <input type="date" name="startDate" required>
      </div>

      <div class="exploitation__field">
        <label>Tugash sana</label>
        <input type="date" name="endDate">
      </div>

      <div class="exploitation__field">
        <label>Boshlang‘ich km</label>
        <input type="number" name="startKilometer">
      </div>

      <div class="exploitation__field">
        <label>Oxirgi km</label>
        <input type="number" name="endKilometer">
      </div>

      <div class="exploitation__field">
        <label>Nomi</label>
        <input type="text" name="title" required>
      </div>

      <div class="exploitation__field">
        <label>Joylashuv</label>
        <input type="text" name="location">
      </div>

      <div class="exploitation__field">
        <label>Tavsif</label>
        <textarea name="description"></textarea>
      </div>

      <button type="submit" class="exploitation__btn exploitation__btn--save">
        Yangilash
      </button>

    </form>
  </div>
</div>
</div>
<div class="sub-section sub-section_demage">
  <h4>Damage bilan ishlash</h4>
  <button id="demageAddBtn">+ Qo‘shish</button>

  <div class="sub-section_demage_cards" id="demageCardsContainer">
    <!-- Kartalar shu yerga keladi -->
  </div>

  <!-- Qo‘shish modal -->
  <div class="demage-modal" id="demagePostModal" style="display: none;">
    <div class="demage-modal-content">
      <span class="demage-modal-close" id="demagePostClose">×</span>
      <h3>Yangi zarar qo‘shish</h3>
      <form id="demagePostForm">
        <input type="date" id="demageDate" name="damageDate" required placeholder="Sana">
        <input type="text" id="demageType" name="damageType" value="ДТП" required placeholder="Zarar turi">
        <input type="text" id="demageDaraja" name="daraja" placeholder="Daraja">
        <input type="text" id="demageLocation" name="location" placeholder="Joylashuv">
        <input type="text" id="demageQatnashchi" name="qatnashchi" placeholder="Qatnashuvchilar">
        <input type="number" id="demageRemont" name="rasxot_remont" min="0" value="0" placeholder="Remont xarajati">
        <input type="number" id="demageKuzup" name="rasxot_kuzup" min="0" value="0" placeholder="Kuzov xarajati">
        <input type="file" id="demageImage" name="damageImage" accept="image/*">
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>

  <!-- Tahrirlash modal -->
  <div class="demage-modal" id="demagePutModal" style="display: none;">
    <div class="demage-modal-content">
      <span class="demage-modal-close" id="demagePutClose">×</span>
      <h3>Zararni tahrirlash</h3>
      <form id="demagePutForm">
        <input type="text" id="demagePutId">
        <input type="date" id="demagePutDate" name="damageDate" required>
        <input type="text" id="demagePutType" name="damageType" required>
        <input type="text" id="demagePutDaraja" name="daraja">
        <input type="text" id="demagePutLocation" name="location">
        <input type="text" id="demagePutQatnashchi" name="qatnashchi">
        <input type="number" id="demagePutRemont" name="rasxot_remont" min="0">
        <input type="number" id="demagePutKuzup" name="rasxot_kuzup" min="0">
        <input type="file" id="demagePutImage" name="damageImage" accept="image/*">
        <button type="submit"  class="editDemageBtn" 
   >Yangilash</button>
        <button type="button" id="demageDeleteBtn">O‘chirish</button>
      </form>
    </div>
  </div>
</div>

<div class="sub-section sub-section_diagnostic">
  <h4>Diagnostika bilan ishlash</h4>
  <button id="diagnosticAddBtn">+ Qo‘shish</button>

  <div class="sub-section_diagnostic_cards" id="diagnosticCardsContainer">
    <!-- Kartalar shu yerga keladi -->
  </div>

  <!-- Qo‘shish modal -->
  <div class="diagnostic-modal" id="diagnosticPostModal" style="display: none;">
    <div class="diagnostic-modal-content">
      <span class="diagnostic-modal-close" id="diagnosticPostClose">×</span>
      <h3>Yangi diagnostika qo‘shish</h3>
      <form id="diagnosticPostForm">
        <label for="">sana</label>
        <input type="date" id="diagnosticDate" name="inspectionDate" required>

        <label for="">Партнер</label>

        <input type="text" id="diagnosticSource" name="source" value="Партнер" required>
        <label for="">Kilometr</label>
        <input type="number" id="diagnosticMileage" name="mileage" required min="0">
        <label for="manzil">Manzil</label>
        <input type="text" id="diagnosticRegion" name="region" required>
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>

  <!-- Tahrirlash modal -->
  <div class="diagnostic-modal" id="diagnosticPutModal" style="display: none;">
    <div class="diagnostic-modal-content">
      <span class="diagnostic-modal-close" id="diagnosticPutClose">×</span>
      <h3>Diagnostikani tahrirlash</h3>
      <form id="diagnosticPutForm">
        <input type="hidden" id="diagnosticPutId">
        <input type="date" id="diagnosticPutDate" name="inspectionDate" required>
        <input type="text" id="diagnosticPutSource" name="source" required>
        <input type="number" id="diagnosticPutMileage" name="mileage" required min="0">
        <input type="text" id="diagnosticPutRegion" name="region" required>
        <button type="submit">Yangilash</button>
        <button type="button" id="diagnosticDeleteBtn">O‘chirish</button>
      </form>
    </div>
  </div>
</div>

<div class="auction-section">
  <div class="auction-section__header">
    <h4 class="auction-section__title">Auction havolalari</h4>
  
  </div>
  <button id="auctionAddBtn" class="auction-btn auction-btn--add">+ Qo‘shish</button>
  <div class="auction-section__cards" id="auctionCardsContainer">
    <!-- Kartalar shu yerga keladi -->
  </div>

  <!-- Qo‘shish modal -->
  <div class="auction-modal" id="auctionPostModal" style="display: none;">
    <div class="auction-modal__overlay" id="auctionPostOverlay"></div>
    <div class="auction-modal__content">
      <div class="auction-modal__header">
        <h3 class="auction-modal__title">Yangi auction qo‘shish</h3>
        <div class="auction-modal__close" id="auctionPostClose">×</div>
      </div>
      <div class="auction-modal__body">
        <form id="auctionPostForm" class="auction-form">
          <div class="auction-form__group">
            <label class="auction-form__label">Rasm <span class="required">*</span></label>
            <input type="file" class="auction-form__input" id="auctionImage" name="image" accept="image/*" required>
          </div>

          <div class="auction-form__group">
            <label class="auction-form__label">Havola (link) <span class="required">*</span></label>
            <input type="url" class="auction-form__input" id="auctionLink" name="link" required placeholder="https://...">
          </div>

          <div class="auction-form__actions">
            <button type="submit" class="auction-btn auction-btn--save">Saqlash</button>
            <button type="button" class="auction-btn auction-btn--cancel" id="auctionPostCancel">Bekor qilish</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tahrirlash modal -->
  <div class="auction-modal" id="auctionPutModal" style="display: none;">
    <div class="auction-modal__overlay" id="auctionPutOverlay"></div>
    <div class="auction-modal__content">
      <div class="auction-modal__header">
        <h3 class="auction-modal__title">Auctionni tahrirlash</h3>
        <div class="auction-modal__close" id="auctionPutClose">×</div>
      </div>
      <div class="auction-modal__body">
        <form id="auctionPutForm" class="auction-form">
          <input type="hidden" id="auctionPutId">

          <div class="auction-form__group">
            <label class="auction-form__label">Rasm (yangi yuklash ixtiyoriy)</label>
            <input type="file" class="auction-form__input" id="auctionPutImage" name="image" accept="image/*">
            <small id="auctionPutImagePreview" class="auction-form__hint">Hozircha rasm yo‘q</small>
          </div>

          <div class="auction-form__group">
            <label class="auction-form__label">Havola (link)</label>
            <input type="url" class="auction-form__input" id="auctionPutLink" name="link" required>
          </div>

          <div class="auction-modal__footer">
            <button type="submit" class="auction-btn auction-btn--save">Yangilash</button>
            <button type="button" class="auction-btn auction-btn--delete" id="auctionDeleteBtn">O‘chirish</button>
            <button type="button" class="auction-btn auction-btn--cancel" id="auctionPutCancel">Bekor qilish</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>







    </div>
  </div>

  <!-- Add/Edit Feature Modal -->
  <div id="feature-main-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="close-feature-main">×</span>
      <h3 id="feature-main-title">Yangi xususiyat qo'shish</h3>
      <form id="feature-main-form" enctype="multipart/form-data">
        <input type="hidden" name="id">
        <label>Sarlavha:</label>
        <input type="text" name="title" required>
        <label>Rasm:</label>
        <input type="file" name="image" id="feature-image-input" accept="image/*">
        <div id="feature-preview" style="margin:10px 0;"></div>
        <label>Tartib raqami:</label>
        <input type="number" name="order" value="0" min="0" required>
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>

  <!-- Add/Edit Legal Risk Modal -->
  <div id="risk-main-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" id="close-risk-main">×</span>
      <h3 id="risk-main-title">Yangi huquqiy risk qo'shish</h3>
      <form id="risk-main-form">
        <input type="hidden" name="id">
        <label>Sarlavha:</label>
        <input type="text" name="title" required>
        <label>Matn:</label>
        <textarea name="text" rows="4" required></textarea>
        <label>Tartib raqami:</label>
        <input type="number" name="order" value="0" min="0" required>
        <button type="submit">Saqlash</button>
      </form>
    </div>
  </div>











<!-- Yuridik ishlar (Lizing, Sud, Qidiruv, Zalog) modal -->
<div id="yuridik-modal" class="modal hidden" style="display: none;">
  <div class="modal-content" style="max-width: 900px; width: 95%;">
    <span class="close" onclick="document.getElementById('yuridik-modal').style.display='none'">×</span>
    <h3>Yuridik ma'lumotlar</h3>
    
    <!-- LizingHistory -->
    <div class="sub-section yuridik-section">
      <h4>Lizing tarixi</h4>
      <button class="btn-add" onclick="openAddYuridik('Lizing')">+ Qo‘shish</button>
      <div id="lizing-list" class="card-grid"></div>
    </div>

    <!-- SudHistory -->
    <div class="sub-section yuridik-section">
      <h4>Sud ishlari</h4>
      <button class="btn-add" onclick="openAddYuridik('Sud')">+ Qo‘shish</button>
      <div id="sud-list" class="card-grid"></div>
    </div>

    <!-- QidiruvHistory -->
    <div class="sub-section yuridik-section">
      <h4>Qidiruv tarixi</h4>
      <button class="btn-add" onclick="openAddYuridik('Qidiruv')">+ Qo‘shish</button>
      <div id="qidiruv-list" class="card-grid"></div>
    </div>

    <!-- ZalogHistory -->
    <div class="sub-section yuridik-section">
      <h4>Zalog / hibsga olish</h4>
      <button class="btn-add" onclick="openAddYuridik('Zalog')">+ Qo‘shish</button>
      <div id="zalog-list" class="card-grid"></div>
    </div>

<!-- Voqealar tarixi bo‘limi -->
<div class="yuridik-section">
  <h4>Voqealar tarixi</h4>
  <button class="btn-add" onclick="openEventModal('history', 'add')">+ Yangi voqea qo‘shish</button>
  <div id="historyEventsAccordion" class="accordion-container"></div>
</div>

<!-- Jarima / shtraf hodisalari bo‘limi -->
<div class="yuridik-section">
  <h4>Jarima / shtraf hodisalari</h4>
  <button class="btn-add" onclick="openEventModal('shtraf', 'add')">+ Yangi jarima qo‘shish</button>
  <div id="shtrafEventsAccordion" class="accordion-container"></div>
</div>

<!-- Umumiy hodisa qo‘shish / tahrirlash modal -->
<div id="eventModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width:680px">
    <div class="modal-header">
      <h3 id="eventModalTitle">Yangi hodisa qo‘shish</h3>
      <div class="modal-close" onclick="closeEventModal()">×</div>
    </div>
    <div class="modal-body">
      <form id="eventForm" enctype="multipart/form-data">
        <input type="hidden" id="eventId">
        <input type="hidden" id="eventType"> <!-- history yoki shtraf -->

        <div class="form-group">
          <label>Sana <span class="required">*</span></label>
          <input type="date" id="eventDate" name="date" required>
        </div>

        <div class="form-group">
          <label>Rasm (ixtiyoriy)</label>
          <input type="file" id="eventImage" name="image" accept="image/*">
          <div id="eventImagePreview" style="margin-top:12px"></div>
        </div>

        <div class="form-group">
          <label>Sarlavha <span class="required">*</span></label>
          <input type="text" id="eventTitle" name="title" required>
        </div>

        <div class="form-group">
          <label>Matn <span class="required">*</span></label>
          <textarea id="eventText" name="text" rows="4" required></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-save">Saqlash</button>
          <button type="button" class="btn-cancel" onclick="closeEventModal()">Bekor qilish</button>
        </div>
      </form>
    </div>
  </div>
</div>


  </div>
</div>











  <script>
    // API manzillari
    const CAROUSEL_API = '/api/home-carousel';
    const USERS_API = '/api/users';
    const CARS_API = '/api/cars';
    const FEATURES_API = '/api/features'; // Yangilangan endpoint
    const RISKS_API = '/api/legal-risks'; // Yangilangan endpoint
    const OTCHOT_API = 'http://localhost:5000/api/otchots';
    let selectedCarId = null; 
    // ------------------ Sidebar Navigatsiya ------------------
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        const pageId = item.dataset.page;
        pages.forEach(p => {
          p.classList.toggle('hidden', p.id !== pageId);
        });

        // Sahifa ochilganda ma'lumotlarni yangilash
        if (pageId === 'home-carousel') fetchCarousels();
        if (pageId === 'users') fetchUsers();
        if (pageId === 'page3') fetchCars();
        if (pageId === 'features') fetchFeatures();
        if (pageId === 'legal-risks') fetchLegalRisks();
      });
    });

    // ------------------ Home Carousel CRUD ------------------
    async function fetchCarousels() {
      try {
        const res = await fetch(CAROUSEL_API);
        const data = await res.json();
        const tbody = document.querySelector('#carousel-table tbody');
        tbody.innerHTML = '';

        if (data.success && data.data) {
          data.data.forEach(item => {
            tbody.innerHTML += `
              <tr>
                <td><img src="${item.image || ''}" width="80" onerror="this.src='/uploads/images.webp'"/></td>
                <td><img src="${item.icon || ''}" width="40" onerror="this.src='/uploads/images.webp'"/></td>
                <td>${item.title || '—'}</td>
                <td>${item.text || '—'}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="editCarousel('${item._id}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteCarousel('${item._id}')"><i class="fas fa-trash-alt"></i></button>
                </td>
              </tr>
            `;
          });
        }
      } catch (err) {
        console.error("Carousel yuklash xatosi:", err);
      }
    }
    document.getElementById('add-otchot-main-btn').addEventListener('click', () => {
      const container = document.getElementById('add-otchot-form-container');
      container.style.display = container.style.display === 'none' ? 'flex' : 'none';
    });

    document.getElementById('add-otchot-form').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const res = await fetch(OTCHOT_API, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          document.querySelector('#add-otchot-form-container').style = "display:none"
          alert('Otchot qo‘shildi');
          e.target.reset();
          loadOtchotOptions(); // dropdownni yangilash
        } else {
          alert(data.message);
        }
      } catch (err) {
        alert('Xato');
      }
    });

    async function loadCarOtchots2(carId) {
      selectedCarId=carId
      try {
        const res = await fetch(`${CARS_API}/${carId}`);
        const { success, data } = await res.json();

        if (!success || !data) {
          console.warn('Mashina topilmadi');
          return;
        }

        const container = document.getElementById('otchots-list');
        if (!container) return;

        container.className = 'card-grid'; // kartochka grid
        container.innerHTML = '';
 

        (data.otchots || []).forEach(o => {
          const otchot = o.otchotId || {}; // populate qilingan bo‘lsa
      

          container.innerHTML += `
        <div class="card">
          <img width="160" src="${o.icon || '/uploads/images.webp'}" 
               alt="${o.title || 'Otchot'}" 
               onerror="this.src='/uploads/images.webp';">
          <div class="card-body">
            <div class="card-title">${o.title || 'Nomsiz otchot'}</div>
            <div class="card-subtitle">
              Pozitsiya: <strong>${o.position || '—'}</strong><br>
              ${o.text ? `Matn: ${o.text}` : 'Matn yo‘q'}
            </div>
          </div>
          <div class="card-actions">
            <button class="action-btn btn-edit" onclick="editCarOtchot('${carId}', '${o.otchotId}', ${o.position}, '${o.text || ''}')">
              Tahrirlash
            </button>
            <button class="action-btn btn-delete" onclick="deleteCarOtchot1('${carId}', '${o.otchotId}')">
              O'chirish
            </button>
          </div>
        </div>
      `;
        });

        if (!data.otchots?.length) {
          container.innerHTML = '<p style="text-align:center;color:#64748b;">Hozircha otchot qo‘shilmagan</p>';
        }
      } catch (err) {
        console.error('Otchot yuklash xatosi:', err);
      }
    }

    // ===============================
    // MODAL OCHISH
    // ===============================
    function editCarOtchot(carId, otchotId, position, text) {
   

      document.getElementById("edit-car-id").value = carId;
      document.getElementById("edit-otchot-id1").value = otchotId;
      document.getElementById("edit-position").value = position;
      document.getElementById("edit-text").value = text;

      document.getElementById("edit-otchot-modal1").style.display = "flex";
    }

    // ===============================
    // MODAL YOPISH
    // ===============================
    function closeEditModal() {
      document.getElementById("edit-otchot-modal1").style.display = "none";
    }

    // ===============================
    // SAQLASH (PATCH)
    // ===============================
    async function saveOtchotEdit() {

      const carId = document.getElementById("edit-car-id").value;
      const otchotId = document.getElementById("edit-otchot-id1").value;
      const position = document.getElementById("edit-position").value;
      const text = document.getElementById("edit-text").value;

      try {
        const res = await fetch(
          `${CARS_API}/${carId}/otchots/${otchotId}`,
          {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              position: Number(position),
              text: text
            })
          }
        );

        const data = await res.json();

        if (data.success) {
          closeEditModal();
          loadCarOtchots2(carId); // jadvalni qayta yuklash
        } else {
          alert(data.message || "Xato yuz berdi");
        }

      } catch (err) {
        console.error("Update xato:", err);
      }
    }

    // Mashinadagi otchotni o‘chirish
    async function deleteCarOtchot1(carId, otchotItemId) {
      if (!confirm('Otchotni mashinadan o‘chirishni tasdiqlaysizmi?')) return;

      try {
        const res = await fetch(`${CARS_API}/${carId}/otchots/${otchotItemId}`, {
          method: 'DELETE'
        });

        const result = await res.json();
        if (result.success) {
          loadCarOtchots2(carId);
          alert('Otchot o‘chirildi');
        } else {
          alert(result.message || 'O‘chirishda xato');
        }
      } catch (err) {
        alert('O‘chirish jarayonida xato');
      }
    }
    // Mashina ochilganda otchotlarni yuklash
    window.showCarDetails = async function (id) {
      document.getElementById('current-car-id').value = id;
      document.getElementById('car-details-title').textContent = `Mashina tafsilotlari (${id.slice(-8)})`;
      selectedCarId =id
      await loadCarDetails(id);  
      await loadValuation(id);
    
      
      await loadCarOtchots2(id);   // ← otchotlar yuklanadi
      document.getElementById('car-details-modal').classList.remove('hidden');
    };

    async function loadOtchotOptions() {
      try {
        const res = await fetch(OTCHOT_API);
        const { success, data } = await res.json();

        const select = document.getElementById('otchot-select');
        const tbody = document.querySelector('#otchot-table tbody');

        if (select) {
          select.innerHTML = '<option value="">Otchot tanlang</option>';
        }

        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="4">Yuklanmoqda...</td></tr>';
        }

        if (success && data?.length) {
          // order bo‘yicha saralash (eng muhimi!)
          const sorted = data.sort((a, b) => (a.order || 0) - (b.order || 0));

          // Dropdown uchun
          if (select) {
            sorted.forEach(o => {
              select.innerHTML += `<option value="${o._id}">${o.title || 'Nomsiz'}</option>`;
            });
          }

          // Jadval uchun
          if (tbody) {
            tbody.innerHTML = '';
            sorted.forEach(f => {
              tbody.innerHTML += `
            <tr>
              <td><img src="${f.icon || ''}" width="40" onerror="this.src='/uploads/images.webp';"/></td>
              <td>${f.title || '—'}</td>
              <td>${f.order || 0}</td>           <!-- ← yangi -->
              <td>
                <button class="action-btn btn-edit" onclick="editOtchotMain('${f._id}')"><i class="fas fa-edit"></i></button>
                <button class="action-btn btn-delete" onclick="deleteOtchotMain('${f._id}')"><i class="fas fa-trash-alt"></i></button>
              </td>
            </tr>`;
            });
          }
        } else if (tbody) {
          tbody.innerHTML = '<tr><td colspan="4">Otchotlar topilmadi</td></tr>';
        }
      } catch (err) {
        console.error('Otchotlar yuklanmadi:', err);
      }
    }
    // Mashinaga otchot qo‘shish (sizning forma)
    document.getElementById('add-otchot-form2')?.addEventListener('submit', async e => {
      e.preventDefault();

      const carId = document.getElementById('current-car-id')?.value;
      if (!carId) return alert('Avval mashinani tanlang!');

      const formData = new FormData(e.target);
      const payload = {
        otchotId: formData.get('otchotId'),
        position: parseInt(formData.get('position')),
        text: formData.get('text') || ''
      };

      if (!payload.otchotId || isNaN(payload.position)) {
        return alert('Otchot va pozitsiyani to‘ldiring!');
      }

      try {
        const res = await fetch(`${CARS_API}/${carId}/otchots`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (result.success) {
          e.target.reset();
          loadCarOtchots2(carId);
          alert('Otchot muvaffaqiyatli qo‘shildi!');
        } else {
          alert(result.message || 'Xato yuz berdi');
        }
      } catch (err) {
        alert('Server bilan aloqa xatosi');
      }
    });

    // Otchot tahrirlash modali ochish
    window.editOtchotMain = async function (id) {
      try {
        const res = await fetch(`${OTCHOT_API}/${id}`);
        const { success, data } = await res.json();

        if (!success) {
          return alert('Otchot topilmadi');
        }

        document.getElementById('edit-otchot-id').value = data._id;
        document.getElementById('edit-otchot-title').value = data.title || '';
        document.getElementById('edit-otchot-order').value = data.order || 0;   // ← yangi

        const preview = document.getElementById('edit-otchot-preview');
        preview.innerHTML = data.icon
          ? `<img src="${data.icon}" alt="Joriy icon">`
          : '<p>Hozircha icon yo‘q</p>';

        document.getElementById('edit-otchot-modal').classList.remove('hidden');

      } catch (err) {
        alert('Ma\'lumot yuklashda xato: ' + err.message);
      }
    };
    // Modal ichidagi forma submit
    document.getElementById('edit-otchot-form')?.addEventListener('submit', async e => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const id = formData.get('id');

      try {
        const res = await fetch(`${OTCHOT_API}/${id}`, {
          method: 'PUT',
          body: formData  // file va text ham yuboriladi
        });

        const result = await res.json();

        if (result.success) {
          alert('Otchot yangilandi!');
          document.getElementById('edit-otchot-modal').classList.add('hidden');
          e.target.reset();

          // Ro‘yxatni yangilash
          loadOtchotOptions();
        } else {
          alert(result.message || 'Yangilashda xato');
        }
      } catch (err) {
        alert('Server xatosi: ' + err.message);
      }
    });
    // Icon yuklanganda preview ko‘rsatish
    document.getElementById('edit-otchot-icon')?.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById('edit-otchot-preview').innerHTML =
            `<img src="${ev.target.result}" alt="Yangi icon">`;
        };
        reader.readAsDataURL(file);
      }
    });
    // 3. Asosiy otchotni o‘chirish (DELETE /api/otchots/:id)
    window.deleteOtchotMain = async function (id) {
      if (!confirm('Bu otchotni butunlay o‘chirishni xohlaysizmi?')) return;

      try {
        const res = await fetch(`${OTCHOT_API}/${id}`, { method: 'DELETE' });
        const result = await res.json();

        if (result.success) {
          alert('Otchot o‘chirildi');
          loadOtchotOptions(); // ro‘yxatni yangilash
        } else {
          alert(result.message || 'O‘chirishda xato');
        }
      } catch (err) {
        alert('O‘chirish jarayonida xato');
      }
    };
    loadOtchotOptions();
    async function loadCarOtchots(carId) {
      const carRes = await fetch(`${CARS_API}/${carId}`);
      const carData = await carRes.json();
      const tbody = document.querySelector('#car-otchots-table tbody');
      tbody.innerHTML = '';

      if (carData.success) {
        carData.data.otchots.forEach(o => {
          const otchot = o.otchotId; // Agar populate qilinmasa _id bilan ko‘rinadi
          tbody.innerHTML += `
        <tr>
          <td>${otchot.title || '—'}</td>
          <td><img src="${otchot.icon || ''}" width="40" onerror="this.src='/uploads/images.webp'"/></td>
          <td>${o.position}</td>
          <td>${o.text || '—'}</td>
          <td>
            <button onclick="deleteCarOtchot('${carId}','${otchot._id}')">O‘chirish</button>
          </td>
        </tr>
      `;
        });
      }
    }

    // O‘chirish
    async function deleteCarOtchot(carId, otchotId) {
      if (!confirm('O‘chirishni tasdiqlaysizmi?')) return;
      try {
        await fetch(`${CARS_API}/${carId}/otchots/${otchotId}`, { method: 'DELETE' });
        loadCarOtchots(carId);
      } catch (err) {
        alert('O‘chirishda xato');
      }
    }

    // Boshlang‘ich yuklash
    loadOtchotOptions();

    async function deleteCarousel(id) {
      if (!confirm('O‘chirishni tasdiqlaysizmi?')) return;
      try {
        await fetch(`${CAROUSEL_API}/${id}`, { method: 'DELETE' });
        fetchCarousels();
      } catch (err) {
        alert('O‘chirishda xato');
      }
    }

    window.editCarousel = async function (id) {
      try {
        // 1. Ma'lumotni API'dan olish
        const res = await fetch(`${CAROUSEL_API}/${id}`);
        const data = await res.json();

        if (!data.success) {
          alert('Carousel topilmadi');
          return;
        }

        const item = data.data;

        // 2. Inline edit row yaratish
        const tbody = document.querySelector('#carousel-table tbody');
        const row = Array.from(tbody.rows).find(r => r.querySelector('.btn-edit').onclick.toString().includes(id));
        if (!row) return;

        row.innerHTML = `
      <td><input type="file" id="edit-image-${id}" /></td>
      <td><input type="file" id="edit-icon-${id}" /></td>
      <td><input type="text" id="edit-title-${id}" value="${item.title || ''}" /></td>
      <td><input type="text" id="edit-text-${id}" value="${item.text || ''}" /></td>
      <td>
        <button class="action-btn btn-save" onclick="saveCarousel('${id}')">Save</button>
        <button class="action-btn btn-cancel" onclick="fetchCarousels()">Cancel</button>
      </td>
    `;
      } catch (err) {
        console.error('Edit carousel xatosi:', err);
      }
    };

    window.saveCarousel = async function (id) {
      try {
        const title = document.getElementById(`edit-title-${id}`).value;
        const text = document.getElementById(`edit-text-${id}`).value;
        const imageFile = document.getElementById(`edit-image-${id}`).files[0];
        const iconFile = document.getElementById(`edit-icon-${id}`).files[0];

        const formData = new FormData();
        formData.append('title', title);
        formData.append('text', text);

        if (imageFile) formData.append('image', imageFile);
        if (iconFile) formData.append('icon', iconFile);

        const res = await fetch(`${CAROUSEL_API}/${id}`, {
          method: 'PUT',
          body: formData
        });

        const data = await res.json();
        if (data.success) {
          alert('Yangilandi');
          fetchCarousels();
        } else {
          alert(data.message || 'Yangilashda xato');
        }
      } catch (err) {
        console.error('Save carousel xatosi:', err);
        alert('Yangilashda xato');
      }
    };

    // Add Carousel
    const modal = document.getElementById('modal');
    const addBtn = document.getElementById('add-new');
    const closeModal = document.getElementById('close-modal');
    const modalForm = document.getElementById('modal-form');

    addBtn.addEventListener('click', () => modal.classList.remove('hidden'));
    closeModal.addEventListener('click', () => modal.classList.add('hidden'));

    modalForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(modalForm);
      try {
        const res = await fetch(CAROUSEL_API, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          modalForm.reset();
          modal.classList.add('hidden');
          fetchCarousels();
        } else {
          alert(data.message || 'Xato');
        }
      } catch (err) {
        alert('Server xatosi');
      }
    });

    // ------------------ Users CRUD ------------------
    async function fetchUsers() {
      const tbody = document.querySelector('#users-table tbody');
      tbody.innerHTML = '<tr><td colspan="6">Yuklanmoqda...</td></tr>';

      try {
        const res = await fetch(USERS_API);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        tbody.innerHTML = '';

        if (data.success && data.data?.length > 0) {
          data.data.forEach(user => {
            const date = user.createdAt ? new Date(user.createdAt).toLocaleString('uz-UZ') : '—';
            tbody.innerHTML += `
              <tr>
                <td>${user._id}</td>
                <td>${user.name || '—'}</td>
                <td>${user.phone || '—'}</td>
                <td style="color:${user.isVerified ? 'green' : 'red'}">${user.isVerified ? 'Ha' : 'Yo‘q'}</td>
                <td>${date}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="editUser('${user._id}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteUser('${user._id}')"><i class="fas fa-trash-alt"></i>  </button>
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6">Foydalanuvchilar topilmadi</td></tr>';
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" style="color:red">Xato: ${err.message}</td></tr>`;
      }
    }

    // Add User
    const addUserModal = document.getElementById('add-user-modal');
    const addUserBtn = document.getElementById('add-user-btn');
    const closeAddUser = document.getElementById('close-add-user');
    const addUserForm = document.getElementById('add-user-form');

    addUserBtn.addEventListener('click', () => addUserModal.classList.remove('hidden'));
    closeAddUser.addEventListener('click', () => addUserModal.classList.add('hidden'));

    addUserForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(addUserForm);
      const data = Object.fromEntries(formData);

      try {
        const res = await fetch(USERS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          addUserForm.reset();
          addUserModal.classList.add('hidden');
          fetchUsers();
        } else {
          alert(result.message || 'Xato');
        }
      } catch (err) {
        alert('Server xatosi');
      }
    });

    // Edit User
    const editUserModal = document.getElementById('edit-user-modal');
    const closeEditUser = document.getElementById('close-edit-user');
    const editUserForm = document.getElementById('edit-user-form');

    closeEditUser.addEventListener('click', () => editUserModal.classList.add('hidden'));

    window.editUser = async function (id) {
      try {
        const res = await fetch(`${USERS_API}/${id}`);
        const data = await res.json();
        if (data.success) {
          const user = data.data;
          editUserForm.id.value = user._id;
          editUserForm.name.value = user.name || '';
          editUserForm.phone.value = user.phone || '';
          editUserModal.classList.remove('hidden');
        }
      } catch (err) {
        alert('Ma\'lumot yuklashda xato');
      }
    };

    editUserForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(editUserForm);
      const id = formData.get('id');
      const data = Object.fromEntries(formData);
      delete data.id;

      try {
        const res = await fetch(`${USERS_API}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          editUserForm.reset();
          editUserModal.classList.add('hidden');
          fetchUsers();
        } else {
          alert(result.message || 'Xato');
        }
      } catch (err) {
        alert('Yangilashda xato');
      }
    });

    // Delete User
    window.deleteUser = async function (id) {
      if (!confirm('O‘chirmoqchimisiz?')) return;
      try {
        const res = await fetch(`${USERS_API}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) fetchUsers();
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

    // ------------------ Mashinalar CRUD (Page 3) ------------------
    async function fetchCars() {
      const tbody = document.querySelector('#cars-table tbody');
      tbody.innerHTML = '<tr><td colspan="6">Yuklanmoqda...</td></tr>';

      try {
        const res = await fetch(CARS_API);
        const data = await res.json();
        tbody.innerHTML = '';

        if (data.success && data.data?.length > 0) {
          data.data.forEach(car => {
            const firstImage = car.images[0] && car.images.length > 0 ? car.images[0].url : '/uploads/images.webp';
            tbody.innerHTML += `
              <tr>
                <td><img class="car-preview" width="90" src="${firstImage}" alt="${car.carName || 'Mashina'}" onerror="this.src='/uploads/images.webp'"/></td>
                <td>${car.carName || '—'}</td>
                <td>${car.vin || '—'}</td>
                <td>${car.gosNumber || '—'}</td>
                <td>${car.color || '—'}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="editCar('${car._id}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-view" onclick="showCarDetails('${car._id}')"><i class="fas fa-eye"></i> </button>
                  <button class="action-btn btn-legal-risk" onclick="openYuridikModal('${car._id}')">
    <i class="fas fa-gavel"></i> <!-- sud/huquqiy ikonka -->
  </button>
                  <button class="action-btn btn-delete" onclick="deleteCar('${car._id}')"><i class="fas fa-trash-alt"></i>  </button>
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="6">Mashinalar topilmadi</td></tr>';
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" style="color:red">Xato: ${err.message}</td></tr>`;
      }
    }

    // Add/Edit Car
    const carModal = document.getElementById('car-modal');
    const addCarBtn = document.getElementById('add-car-btn');
    const closeCarModal = document.getElementById('close-car-modal');
    const carForm = document.getElementById('car-form');
    const carModalTitle = document.getElementById('car-modal-title');

    addCarBtn.addEventListener('click', () => {
      carModalTitle.textContent = 'Yangi mashina qo‘shish';
      carForm.reset();
      carForm.id.value = '';
      carModal.classList.remove('hidden');
    });

    closeCarModal.addEventListener('click', () => carModal.classList.add('hidden'));

    carForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(carForm);
      const id = formData.get('id');
      const data = Object.fromEntries(formData);
      delete data.id;

      try {
        let res;
        if (id) {
          res = await fetch(`${CARS_API}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(CARS_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        const result = await res.json();
        if (result.success) {
          carForm.reset();
          carModal.classList.add('hidden');
          fetchCars();
        } else {
          alert(result.message || 'Xato');
        }
      } catch (err) {
        alert('Server xatosi');
      }
    });

    window.editCar = async function (id) {
      try {
        const res = await fetch(`${CARS_API}/${id}`);
        const data = await res.json();
        if (data.success) {
          const car = data.data;
          carModalTitle.textContent = 'Mashinani';
          carForm.id.value = car._id;
          carForm.carName.value = car.carName || '';
          carForm.vin.value = car.vin || '';
          carForm.gosNumber.value = car.gosNumber || '';
          carForm.engineNumber.value = car.engineNumber || '';
          carForm.stsNumber.value = car.stsNumber || '';
          carForm.carType.value = car.carType || '';
          carForm.color.value = car.color || '';
          carForm.engine.value = car.engine || '';
          carModal.classList.remove('hidden');
        }
      } catch (err) {
        alert('Ma\'lumot yuklashda xato');
      }
    };

    // Delete Car
    window.deleteCar = async function (id) {
      if (!confirm('O‘chirmoqchimisiz?')) return;
      try {
        const res = await fetch(`${CARS_API}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) fetchCars();
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

    // Car Details
    const carDetailsModal = document.getElementById('car-details-modal');
    const closeCarDetails = document.getElementById('close-car-details');
    const currentCarId = document.getElementById('current-car-id');
    const carDetailsTitle = document.getElementById('car-details-title');

    closeCarDetails.addEventListener('click', () => carDetailsModal.classList.add('hidden'));

    window.showCarDetails = async function (id) {
      currentCarId.value = id;
      carDetailsTitle.textContent = `Mashina tafsilotlari (ID: ${id})`;
      await loadCarDetails(id);
      await loadCarOtchots2(id)
       await loadValuation(id)
      carDetailsModal.classList.remove('hidden'); 
      await getCarById(id)
    };

    async function loadCarDetails(id) {
      try {
        const res = await fetch(`${CARS_API}/${id}`);
        const data = await res.json();
        if (data.success) {
          const car = data.data;
           getDemage(car.damageHistory)
           renderDiagnosticCards(car.diagnosticHistory)
           auctionRenderCards(car.auctionHistory)
          // Images

          const imagesList = document.getElementById('images-list');
          imagesList.innerHTML = '';

          (car.images || []).forEach((img, index) => {
            const labelText = img.label ? `<div class="label">${img.label}</div>` : '';
            const damagedText = img.isDamaged ? '<div class="damaged">Zararlangan</div>' : '';

            imagesList.innerHTML += `
        <div class="car-image-card">
          <img style='100%' src="${img.url || ''}" alt="Rasm ${index + 1}" onerror="this.src='/uploads/images.webp'">
          ${labelText}
          ${damagedText}
          <div class="actions">
            <button class="action-btn btn-delete" onclick="deleteImage('${id}',  '${img.url}')">
              <i class="fas fa-trash-alt"></i>  
            </button>
          </div>
        </div>
      `;
          });
          // Extra Gos
          const extraGosList = document.getElementById('extra-gos-list');
          extraGosList.innerHTML = '';
          (car.extraGosNumber || []).forEach(num => {
            extraGosList.innerHTML += `
              <div class="list-item">
                <span>${num}</span>
                <div style="display:flex;gap:10px">
                  <button class="action-btn btn-edit" onclick="editExtraGos('${id}', '${num}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteExtraGos('${id}', '${num}')"><i class="fas fa-trash-alt"></i>  </button>
                </div>
              </div>
            `;
          });

          // Features
          const featuresList = document.getElementById('features-list');
          featuresList.innerHTML = '';
          (car.features || []).forEach(f => {
            featuresList.innerHTML += `
              <div style="display:block" class="list-item">
                <img src="${f.image}">
                <span>${f.title || f.featureId} - ${f.text || ''}</span>
                <div style="display:flex;gap:10px">
                  <button class="action-btn btn-edit" onclick="editFeature('${id}', '${f.featureId}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteFeature('${id}', '${f.featureId}')"><i class="fas fa-trash-alt"></i>  </button>
                </div>
              </div>
            `;
          });

          // Risks
          const risksList = document.getElementById('risks-list');
          risksList.innerHTML = '';
          (car.legalRisks || []).forEach(r => {
            risksList.innerHTML += `
              <div style="padding:10px;width:100%" class="list-item chip chip-risk-${4 - r.position}">
                <span>${r.title} (${r.position})</span>
                <p style="margin-top:15px;margin-bottom:15px">${r.text}</p>
                <div style="display:flex;gap:10px">
                  <button class="action-btn btn-edit" onclick="editRisk('${id}', '${r.riskId}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteRisk('${id}', '${r.riskId}')"><i class="fas fa-trash-alt"></i>  </button>
                </div>
              </div>
            `;
          });
        }
      } catch (err) {
        alert('Tafsilotlar yuklashda xato');
      }
    }

    // Add Image (faraz qilingan endpoint /api/cars/:id/images)
    const addImageForm = document.getElementById('add-image-form');
    addImageForm.addEventListener('submit', async e => {
      e.preventDefault();
      const id = currentCarId.value;
      const formData = new FormData(addImageForm);
      try {
        const res = await fetch(`${CARS_API}/${id}/images`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          addImageForm.reset();
          loadCarDetails(id);
        } else {
          alert(data.message || 'Xato');
        }
      } catch (err) {
        alert('Rasm qo‘shishda xato');
      }
    });

window.deleteImage = async function (carId, imageUrl) {
  if (!confirm('Rasmni o‘chirmoqchimisiz?')) return;

  try {
    const res = await fetch(`${CARS_API}/${carId}/images`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ url: imageUrl })
    });

    const data = await res.json();

    if (data.success) {
      loadCarDetails(carId);
    } else {
      alert(data.message || 'O‘chirishda xato');
    }

  } catch (err) {
    console.error(err);
    alert('Server bilan bog‘lanishda xato');
  }
};


    // Extra Gos
    const addExtraGosForm = document.getElementById('add-extra-gos-form');
    addExtraGosForm.addEventListener('submit', async e => {
      e.preventDefault();
      const id = currentCarId.value;
      const formData = new FormData(addExtraGosForm);
      const data = Object.fromEntries(formData);
      try {
        const res = await fetch(`${CARS_API}/${id}/gos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          addExtraGosForm.reset();
          loadCarDetails(id);
        } else {
          alert(result.message || 'Xato');
        }
      } catch (err) {
        alert('Qo‘shishda xato');
      }
    });

    window.editExtraGos = async function (id, oldNumber) {
      const newNumber = prompt('Yangi raqam:', oldNumber);
      if (!newNumber) return;
      try {
        const res = await fetch(`${CARS_API}/${id}/gos/${oldNumber}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newNumber })
        });
        const data = await res.json();
        if (data.success) loadCarDetails(id);
      } catch (err) {
        alert('Yangilashda xato');
      }
    };

    window.deleteExtraGos = async function (id, number) {
      if (!confirm('O‘chirmoqchimisiz?')) return;
      try {
        const res = await fetch(`${CARS_API}/${id}/gos/${number}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) loadCarDetails(id);
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

    // Features
    async function loadFeatures() {
      try {
        const res = await fetch(FEATURES_API);
        const data = await res.json();
        const select = document.getElementById('feature-select');
        select.innerHTML = '<option value="">Tanlang</option>';
        if (data.success && data.data) {
          data.data.forEach(f => {
            select.innerHTML += `<option value="${f._id}">${f.title}</option>`;
          });
        }
      } catch (err) {
        console.error('Features yuklash xatosi');
      }
    }

    const addFeatureForm = document.getElementById('add-feature-form');
    addFeatureForm.addEventListener('submit', async e => {
      e.preventDefault();
      const id = currentCarId.value;
      const formData = new FormData(addFeatureForm);
      const data = Object.fromEntries(formData);
      try {
        const res = await fetch(`${CARS_API}/${id}/features`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          addFeatureForm.reset();
          loadCarDetails(id);
        } else {
          alert(result.message || 'Xato');
        }
      } catch (err) {
        alert('Qo‘shishda xato');
      }
    });

    window.editFeature = async function (id, featureId) {
      const newText = prompt('Yangi matn:');
      if (newText === null) return;
      try {
        const res = await fetch(`${CARS_API}/${id}/features/${featureId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: newText })
        });
        const data = await res.json();
        if (data.success) loadCarDetails(id);
      } catch (err) {
        alert('Yangilashda xato');
      }
    };

    window.deleteFeature = async function (id, featureId) {
      if (!confirm('O‘chirmoqchimisiz?')) return;
      try {
        const res = await fetch(`${CARS_API}/${id}/features/${featureId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) loadCarDetails(id);
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

    // Risks
    async function loadRisks() {
      try {
        const res = await fetch(RISKS_API);
        const data = await res.json();
        const select = document.getElementById('risk-select');
        select.innerHTML = '<option value="">Tanlang</option>';
        if (data.success && data.data) {
          data.data.forEach(r => {
            select.innerHTML += `<option value="${r._id}">${r.title}</option>`;
          });
        }
      } catch (err) {
        console.error('Risks yuklash xatosi');
      }
    }

    const addRiskForm = document.getElementById('add-risk-form');
    addRiskForm.addEventListener('submit', async e => {
      e.preventDefault();
      const id = currentCarId.value;
      const formData = new FormData(addRiskForm);
      const data = Object.fromEntries(formData);
      try {
        const res = await fetch(`${CARS_API}/${id}/legal-risks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          addRiskForm.reset();
          loadCarDetails(id);
        } else {
          alert(result.message || 'Xato');
        }
      } catch (err) {
        alert('Qo‘shishda xato');
      }
    });

    window.editRisk = async function (id, riskId) {
      const newPosition = prompt('Yangi pozitsiya (1-3):');
      if (!newPosition || ![1, 2, 3].includes(parseInt(newPosition))) return alert('Noto‘g‘ri pozitsiya');
      try {
        const res = await fetch(`${CARS_API}/${id}/legal-risks/${riskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ position: parseInt(newPosition) })
        });
        const data = await res.json();
        if (data.success) loadCarDetails(id);
      } catch (err) {
        alert('Yangilashda xato');
      }
    };

    window.deleteRisk = async function (id, riskId) {
      if (!confirm('O‘chirmoqchimisiz?')) return;
      try {
        const res = await fetch(`${CARS_API}/${id}/legal-risks/${riskId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) loadCarDetails(id);
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

    // ------------------ Features CRUD ------------------
    async function fetchFeatures() {
      const tbody = document.querySelector('#features-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Yuklanmoqda...</td></tr>';

      try {
        const res = await fetch(FEATURES_API);
        const data = await res.json();
        tbody.innerHTML = '';

        if (data.success && data.data?.length > 0) {
          // order bo'yicha tartiblash
          const sortedFeatures = [...data.data].sort((a, b) => (a.order || 0) - (b.order || 0));
          sortedFeatures.forEach(f => {
            tbody.innerHTML += `
              <tr>
                <td><img src="${f.image || ''}" width="30" style="border-radius:6px; object-fit:cover; height:30px;" onerror="this.src='/uploads/images.webp'"/></td>
                <td><strong>${f.title || '—'}</strong></td>
                <td>${f.order || 0}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="editFeatureMain('${f._id}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteFeatureMain('${f._id}')"><i class="fas fa-trash-alt"></i>  </button>
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4">Xususiyatlar topilmadi</td></tr>';
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" style="color:red">Xato: ${err.message}</td></tr>`;
      }
    }

    const featureMainModal = document.getElementById('feature-main-modal');
    const addFeatureMainBtn = document.getElementById('add-feature-main-btn');
    const closeFeatureMain = document.getElementById('close-feature-main');
    const featureMainForm = document.getElementById('feature-main-form');
    const featureMainTitle = document.getElementById('feature-main-title');
    const featurePreview = document.getElementById('feature-preview');

    addFeatureMainBtn.addEventListener('click', () => {
      featureMainTitle.textContent = 'Yangi xususiyat qo‘shish';
      featureMainForm.reset();
      featureMainForm.id.value = '';
      featurePreview.innerHTML = '';
      featureMainModal.classList.remove('hidden');
    });

    closeFeatureMain.addEventListener('click', () => featureMainModal.classList.add('hidden'));

    // Rasm preview
    document.getElementById('feature-image-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          featurePreview.innerHTML = `<img src="${ev.target.result}" style="max-width:180px; border-radius:6px;">`;
        };
        reader.readAsDataURL(file);
      }
    });

    featureMainForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(featureMainForm);
      const id = formData.get('id');

      try {
        let res;
        if (id) {
          res = await fetch(`${FEATURES_API}/${id}`, {
            method: 'PUT',
            body: formData
          });
        } else {
          res = await fetch(FEATURES_API, {
            method: 'POST',
            body: formData
          });
        }

        const result = await res.json();
        if (result.success) {
          featureMainForm.reset();
          featureMainModal.classList.add('hidden');
          featurePreview.innerHTML = '';
          fetchFeatures();
          loadFeatures();
        } else {
          alert(result.message || 'Xato yuz berdi');
        }
      } catch (err) {
        alert('Server bilan aloqa xatosi');
      }
    });

    window.editFeatureMain = async function (id) {
      try {
        const res = await fetch(`${FEATURES_API}/${id}`);
        const data = await res.json();
        if (data.success) {
          const f = data.data;
          featureMainTitle.textContent = 'Xususiyatni';
          featureMainForm.id.value = f._id;
          featureMainForm.title.value = f.title || '';
          featureMainForm.order.value = f.order || 0;
          featurePreview.innerHTML = f.image ? `<img src="${f.image}" style="max-width:180px;">` : '';
          featureMainModal.classList.remove('hidden');
        }
      } catch (err) {
        alert('Ma\'lumot yuklashda xato');
      }
    };

    window.deleteFeatureMain = async function (id) {
      if (!confirm('O‘chirishni xohlaysizmi?')) return;
      try {
        const res = await fetch(`${FEATURES_API}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          fetchFeatures();
          loadFeatures();
        }
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

    // ------------------ Legal Risks CRUD ------------------
    async function fetchLegalRisks() {
      const tbody = document.querySelector('#risks-table tbody');
      tbody.innerHTML = '<tr><td colspan="4">Yuklanmoqda...</td></tr>';

      try {
        const res = await fetch(RISKS_API);
        const data = await res.json();
        tbody.innerHTML = '';

        if (data.success && data.data?.length > 0) {
          data.data.forEach(r => {
            tbody.innerHTML += `
              <tr>
                <td>${r.title || '—'}</td>
                <td>${r.text?.substring(0, 80) || '—'}...</td>
                <td>${r.order || 0}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="editRiskMain('${r._id}')"><i class="fas fa-edit"></i></button>
                  <button class="action-btn btn-delete" onclick="deleteRiskMain('${r._id}')"><i class="fas fa-trash-alt"></i>  </button>
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="4">Risklar topilmadi</td></tr>';
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4" style="color:red">Xato: ${err.message}</td></tr>`;
      }
    }

    const riskMainModal = document.getElementById('risk-main-modal');
    const addRiskMainBtn = document.getElementById('add-risk-main-btn');
    const closeRiskMain = document.getElementById('close-risk-main');
    const riskMainForm = document.getElementById('risk-main-form');
    const riskMainTitle = document.getElementById('risk-main-title');

    addRiskMainBtn.addEventListener('click', () => {
      riskMainTitle.textContent = 'Yangi huquqiy risk qo‘shish';
      riskMainForm.reset();
      riskMainForm.id.value = '';
      riskMainModal.classList.remove('hidden');
    });

    closeRiskMain.addEventListener('click', () => riskMainModal.classList.add('hidden'));

    riskMainForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(riskMainForm);
      const id = formData.get('id');
      const data = Object.fromEntries(formData);
      delete data.id;

      try {
        let res;
        if (id) {
          res = await fetch(`${RISKS_API}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(RISKS_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        const result = await res.json();
        if (result.success) {
          riskMainForm.reset();
          riskMainModal.classList.add('hidden');
          fetchLegalRisks();
          loadRisks();
        } else {
          alert(result.message || 'Xato yuz berdi');
        }
      } catch (err) {
        alert('Server bilan aloqa xatosi');
      }
    });

    window.editRiskMain = async function (id) {
      try {
        const res = await fetch(`${RISKS_API}/${id}`);
        const data = await res.json();
        if (data.success) {
          const r = data.data;
          riskMainTitle.textContent = 'Riskni';
          riskMainForm.id.value = r._id;
          riskMainForm.title.value = r.title || '';
          riskMainForm.text.value = r.text || '';
          riskMainForm.order.value = r.order || 0;
          riskMainModal.classList.remove('hidden');
        }
      } catch (err) {
        alert('Ma\'lumot yuklashda xato');
      }
    };

    window.deleteRiskMain = async function (id) {
      if (!confirm('O‘chirishni xohlaysizmi?')) return;
      try {
        const res = await fetch(`${RISKS_API}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          fetchLegalRisks();
          loadRisks();
        }
      } catch (err) {
        alert('O‘chirishda xato');
      }
    };

// submit bosilganda
document
  .getElementById("saleHistory_submit")
  .addEventListener("click", async function () {

    if (!selectedCarId) {
      return alert("Avval mashinani qidiring!");
    }

    const form = document.querySelector(".saleHistory_modal form");

    const payload = {
      saleDate: form.saleHistory_date.value,
      title: form.saleHistory_title.value,
      price: form.saleHistory_price.value,
      priceDrop: form.saleHistory_priceOld.value,
      probeg: form.saleHistory_probeg.value,
      region: form.saleHistory_shaxar.value,
      holati: form.saleHistory_holati.value,
      link: form.saleHistory_link.value,

    };

    try {
      const res = await fetch(
        `/api/cars/${selectedCarId}/sales-history`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        }
      );

      const data = await res.json();

      if (!data.success) {
        return alert(data.message);
      }

      alert("Sotuv tarixi qo‘shildi ✅");

      // formni tozalash
      form.reset();

      // modal yopish
      document.querySelector(".saleHistory_modal").style.display = "none";

      // agar kerak bo‘lsa ro‘yxatni yangilash
      getCarById(selectedCarId)

    } catch (err) {
      console.error(err);
      alert("Xatolik yuz berdi");
    }
});

async function getCarById(id) {
  const res = await fetch(`/api/cars/${id}`);
  const data = await res.json();

  if (!data.success) {
    return alert(data.message);
  }

  currentCar = data.data;

  renderSaleHistory(currentCar.salesHistory || []);
}


function renderSaleHistory(historyArray) {


  const container = document.querySelector(".saleHistory_cards");
  container.innerHTML = ""; // tozalash

  if (!historyArray.length) {
    container.innerHTML = "<p>Sotuv tarixi mavjud emas</p>";
    return;
  }

  historyArray.forEach((item, index) => {

    const table = document.createElement("table");


    table.innerHTML = `
      <tbody>
        <tr>
          <th>Sanasi</th>
          <td>${item.saleDate || "-"}</td>
        </tr>
        <tr>
          <th>Title</th>
          <td>${item.title || "-"}</td>
        </tr>
        <tr>
          <th>Narxi</th>
          <td>${item.price || 0}</td>
        </tr>
        <tr>
          <th>Narxi tushishi</th>
          <td>${item.priceDrop || 0}</td>
        </tr>
        <tr>
          <th>Probeg</th>
          <td>${item.probeg || 0}</td>
        </tr>
        <tr>
          <th>Shaxar</th>
          <td>${item.region || "-"}</td>
        </tr>
        <tr>
          <th>Holati</th>
          <td>${item.holati || "-"}</td>
        </tr>
        <tr>
          <th>Link</th>
          <td>${item.link ? `<a href="${item.link}" target="_blank">Ko‘rish</a>` : "-"}</td>
        </tr>
        <tr>
          <td>
            <button onclick='editSaleHistory(${JSON.stringify(item)})'>Yangilash</button>
          </td>
          <td>
            <button onclick="deleteSaleHistory('${item._id}')">O‘chirish</button>
          </td>
        </tr>
      </tbody>
    `;

    container.appendChild(table);
  });
}
let editingSaleHistoryId = null;
function editSaleHistory(item) {

  editingSaleHistoryId = item._id;

  const modal = document.querySelector('.saleHistory_modal2');
  modal.style.display = "flex";

  document.querySelector('[name="saleHistory_date2"]').value =
    item.saleDate ? item.saleDate.split("T")[0] : '';

  document.querySelector('[name="saleHistory_title2"]').value = item.title || '';
  document.querySelector('[name="saleHistory_price2"]').value = item.price || 0;
  document.querySelector('[name="saleHistory_priceOld2"]').value = item.priceDrop || 0;
  document.querySelector('[name="saleHistory_probeg2"]').value = item.probeg || 0;
  document.querySelector('[name="saleHistory_shaxar2"]').value = item.region || '';
  document.querySelector('[name="saleHistory_holati2"]').value = item.holati || '';
  document.querySelector('[name="saleHistory_link2"]').value = item.link || '';
}
async function deleteSaleHistory(historyId) {

  if (!selectedCarId) {
    return alert("Avval mashinani tanlang!");
  }

  const confirmDelete = confirm("Rostdan ham ushbu sotuv tarixini o‘chirmoqchimisiz?");
  if (!confirmDelete) return;

  try {
    const res = await fetch(
      `/api/cars/${selectedCarId}/sales-history/${historyId}`,
      {
        method: "DELETE"
      }
    );

    const data = await res.json();

    if (!data.success) {
      return alert(data.message || "O‘chirishda xatolik");
    }

    alert("Sotuv tarixi o‘chirildi ✅");

    // qayta yuklash
    getCarById(selectedCarId);

  } catch (err) {
    console.error("Delete xato:", err);
    alert("Server xatosi yuz berdi");
  }
}
document.querySelector("#saleHistory_submit2").addEventListener("click", async function () {

    if (!selectedCarId || !editingSaleHistoryId) {
      return alert("Xatolik: ID topilmadi");
    }

    const body = {
      saleDate: document.querySelector('[name="saleHistory_date2"]').value,
      title: document.querySelector('[name="saleHistory_title2"]').value,
      price: Number(document.querySelector('[name="saleHistory_price2"]').value),
      priceDrop: Number(document.querySelector('[name="saleHistory_priceOld2"]').value),
      probeg: Number(document.querySelector('[name="saleHistory_probeg2"]').value),
      region: document.querySelector('[name="saleHistory_shaxar2"]').value,
      holati: document.querySelector('[name="saleHistory_holati2"]').value,
      link: document.querySelector('[name="saleHistory_link2"]').value
    };


    try {

      const res = await fetch(
        `/api/cars/${selectedCarId}/sales-history/${editingSaleHistoryId}`,
        {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        }
      );

      const data = await res.json();

      if (!data.success) {
        return alert(data.message || "Yangilashda xatolik");
      }

      alert("Yangilandi ✅");

      document.querySelector('.saleHistory_modal2').style.display = "none";

      // qayta yuklash
      getCarById(selectedCarId);

    } catch (err) {
      console.error("Update xato:", err);
      alert("Server xatosi");
    }

  });




async function loadValuation(carId) {
  try {

    /* ===== VALUATION ===== */
    const res = await fetch(`/api/cars/${carId}/valuation`);
    const result = await res.json();

    if (result.success && result.data) {
      document.getElementById('valuationLow').value = result.data.valuationLow || '';
      document.getElementById('valuationRangeLow').value = result.data.valuationRangeLow || '';
      document.getElementById('valuationRangeHigh').value = result.data.valuationRangeHigh || '';
      document.getElementById('valuationHigh').value = result.data.valuationHigh || '';
      document.getElementById('currency').value = result.data.currency || 'UZS';
      document.getElementById('saveBtn').textContent = 'Yangilash';
    }

    /* ===== PROBEG ===== */
    const probegRes = await fetch(`/api/cars/${carId}/probeg-history`);
    const probegResult = await probegRes.json();

    if (probegResult.success) {
      renderProbegCards(probegResult.data);
    }

    /* ===== EXPLOITATION ===== */
    const exploitationRes = await fetch(`/api/cars/${carId}/exploitation-history`);
    const exploitationResult = await exploitationRes.json();

    if (exploitationResult.success) {
      renderExploitationCards(exploitationResult.data);
    }

  } catch (err) {
    console.error('Xato:', err);
  }
}

function renderProbegCards(data) {

  const container = document.getElementById("adminProbeg_cards");
  container.innerHTML = "";

  data.forEach(item => {

    container.innerHTML += `
      <div class="adminProbeg_card">
        <h3><b>Yil:</b> ${item.year}</h3>
        <p><b>Kilometr:</b> ${item.kilometer.toLocaleString()} km</p>

        <div class="adminProbeg_button">
          <button onclick="editProbeg('${item._id}', ${item.year}, ${item.kilometer})">
            Edit
          </button>
          <button onclick="deleteProbeg('${item._id}')">
            Delete
          </button>
        </div>
      </div>
    `;
  });
}

// Forma yuborilganda
document.getElementById('valuationForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const data = {
    valuationLow: document.getElementById('valuationLow').value || 0,
    valuationRangeLow: document.getElementById('valuationRangeLow').value || 0,
    valuationRangeHigh: document.getElementById('valuationRangeHigh').value || 0,
    valuationHigh: document.getElementById('valuationHigh').value || 0,
    currency: document.getElementById('currency').value
  };

  // Agar hech qanday narx kiritilmagan bo‘lsa — ogohlantirish
  if (
    data.valuationLow == 0 &&
    data.valuationRangeLow == 0 &&
    data.valuationRangeHigh == 0 &&
    data.valuationHigh == 0
  ) {
    alert('Kamida bitta narx chegarasini kiriting!');
    return;
  }

  try {
    const res = await fetch(`/api/cars/${selectedCarId}/valuation`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (result.success) {
      alert('Narx bahosi muvaffaqiyatli yangilandi!');
     
      // Agar xohlasangiz formani tozalash yoki sahifani refresh qilish mumkin
      // location.reload();
    } else {
      alert('Xato: ' + result.message);
    }
  } catch (err) {
    alert(err);
    console.error(err);
  }
});

// Tozalash tugmasi
document.getElementById('clearBtn').addEventListener('click', function() {
  document.getElementById('valuationForm').reset();
});

// Sahifa yuklanganda eski ma'lumotlarni yuklash
function openPostModal() {
  document.querySelector('.modal_adminProbeg_post').style.display = 'flex';
}
function openPutModal() {
document.getElementById('modalPutProbeg').style.display = 'flex';
}
function editProbeg(id, year, kilometer) {
console.log(id, year,kilometer);

  document.querySelector('.modal_adminProbeg_put').style.display = "flex";
 document.querySelector('#probegPutForm .probegId').value = id;


  document.getElementById('putYear').value = year;

  document.getElementById('putKilometer').value = kilometer;
}

function closeModals() {
  document.querySelectorAll('.modal_adminProbeg')
    .forEach(m => m.style.display = 'none');
}
document.getElementById("probegPostForm")
  .addEventListener("submit", async function(e) {

    e.preventDefault();

    const year = this.year.value;
    const kilometer = this.kilometer.value;

    const res = await fetch(`/api/cars/${selectedCarId}/probeg-history`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year, kilometer })
    });

    const result = await res.json();

    if (result.success) {
      closeModals();
      loadValuation(selectedCarId);
    }
  });
document.getElementById("probegPutForm")
  .addEventListener("submit", async function(e) {

    e.preventDefault();

    const id = this.probegId.value;
    const year = this.year.value;
    const kilometer = this.kilometer.value;

    const res = await fetch(
      `/api/cars/${selectedCarId}/probeg-history/${id}`,
      {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ year, kilometer })
      }
    );

    const result = await res.json();

    if (result.success) {
      closeModals();
      loadValuation(selectedCarId);
    }
  });
async function deleteProbeg(id) {

  if (!confirm("O‘chirishni tasdiqlaysizmi?")) return;

  const res = await fetch(
    `/api/cars/${selectedCarId}/probeg-history/${id}`,
    { method: "DELETE" }
  );

  const result = await res.json();

  if (result.success) {
    loadValuation(selectedCarId);
  }
}


function formatDate(date) {
  return new Date(date).toISOString().split('T')[0];
}
let exploitationData=[]
function renderExploitationCards(data) {
  const container = document.getElementById('exploitationCards');
  container.innerHTML = '';

  if (!data.length) {
    container.innerHTML = '<p>Ma\'lumot mavjud emas</p>';
    return;
  }
exploitationData=data
  data.forEach(item => {
    container.innerHTML += `
      <div class="exploitation__card">
        <h5>${item.title}</h5>
        <p><b>Davr:</b> 
          ${formatDate(item.startDate)} - 
          ${item.endDate ? formatDate(item.endDate) : 'Hozirgacha'}
        </p>
        <p><b>Kilometr:</b> 
          ${item.startKilometer} → ${item.endKilometer}
        </p>
        <p><b>Joy:</b> ${item.location || '-'}</p>

        <div class="exploitation__actions">
          <button 
            class="exploitation__btn exploitation__btn--edit"
            onclick="editExploitation('${item._id}')">
            Edit
          </button>

          <button 
            class="exploitation__btn exploitation__btn--delete"
            onclick="deleteExploitation('${item._id}')">
            Delete
          </button>
        </div>
      </div>
    `;
  });
}
function openExploitationPost() {
  document.getElementById('exploitationPostModal').style="display:flex";
}

function openExploitationPut() {
  document.getElementById('exploitationPutModal').style="display:flex";
}

function closeExploitationModal() {
  document.querySelectorAll('.exploitation__modal').forEach(modal => {
    modal.style.display = 'none';
  });
}
const exploitationPostForm = document.getElementById('exploitationPostForm');

exploitationPostForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(exploitationPostForm);
  const data = Object.fromEntries(formData.entries());

  try {
    const res = await fetch(`/api/cars/${selectedCarId}/exploitation-history`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (result.success) {
      alert('Muvaffaqiyatli qo‘shildi');
      document.querySelector('#exploitationPostModal').style="display:none"
      exploitationPostForm.reset();
     loadValuation(selectedCarId);
    } else {
      alert(result.message);
    }

  } catch (err) {
    console.error(err);
   
    alert('Xatolik yuz berdi'); document.querySelector('.exploitationPostModal').style="display:none"
  }
});
let currentEditId = null;

function editExploitation(id) {
  const item = exploitationData.find(x => x._id === id);
  if (!item) return;

  currentEditId = id;

  const form = document.getElementById('exploitationPutForm');

  form.exploitationId.value = id;
  form.startDate.value = item.startDate?.slice(0, 10);
  form.endDate.value = item.endDate ? item.endDate.slice(0, 10) : '';
  form.startKilometer.value = item.startKilometer || 0;
  form.endKilometer.value = item.endKilometer || 0;
  form.title.value = item.title || '';
  form.location.value = item.location || '';
  form.description.value = item.description || '';

  openExploitationPut();
}
const exploitationPutForm = document.getElementById('exploitationPutForm');

exploitationPutForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = exploitationPutForm.exploitationId.value;

  const formData = new FormData(exploitationPutForm);
  const data = Object.fromEntries(formData.entries());

  delete data.exploitationId;

  try {
    const res = await fetch(`/api/cars/${selectedCarId}/exploitation-history/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (result.success) {
      alert('Yangilandi');
      closeExploitationModal();
      loadValuation(selectedCarId);
    } else {
      alert(result.message);
    }

  } catch (err) {
    console.error(err);
    alert('Xatolik');
  }
});
async function deleteExploitation(id) {
  if (!confirm('O‘chirishga ishonchingiz komilmi?')) return;

  try {
    const res = await fetch(`/api/cars/${selectedCarId}/exploitation-history/${id}`, {
      method: 'DELETE'
    });

    const result = await res.json();

    if (result.success) {
      alert('O‘chirildi');
      loadValuation(selectedCarId);
    } else {
      alert(result.message);
    }

  } catch (err) {
    console.error(err);
    alert('Xatolik');
  }
}
function getDemage(data) {
  const container = document.getElementById('demageCardsContainer');
  container.innerHTML = '';

  if (!data || data.length === 0) {
    container.innerHTML = '<p>Hozircha ma\'lumot yo‘q</p>';
    return;
  }

  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'sub-section_demage_card';
    card.innerHTML = `
      <div>${item.damageDate ? new Date(item.damageDate).toLocaleDateString('uz-UZ') : '—'}</div>
      <h5>${item.damageType || '—'}</h5>
      <p><strong>Daraja:</strong> ${item.daraja || '—'}</p>
      <p><strong>Joy:</strong> ${item.location || '—'}</p>
      <p><strong>Qatnashuvchilar:</strong> ${item.qatnashchi || '—'}</p>
      <p>Remont: ${Number(item.rasxot_remont || 0).toLocaleString('uz-UZ')} so‘m</p>
      <p>Kuzov: ${Number(item.rasxot_kuzup || 0).toLocaleString('uz-UZ')} so‘m</p>
      
      ${item.damageImage ? `<img src="${item.damageImage}" style="width:250px" alt="rasm" style="max-width:100%;">` : ''}
      
      <button class="editDemageBtn" 
        data-id="${item._id}"
        data-date="${item.damageDate ? new Date(item.damageDate).toISOString().split('T')[0] : ''}"
        data-type="${item.damageType || ''}"
        data-daraja="${item.daraja || ''}"
        data-location="${item.location || ''}"
        data-qatnashchi="${item.qatnashchi || ''}"
        data-remont="${item.rasxot_remont || 0}"
        data-kuzup="${item.rasxot_kuzup || 0}"
        data-image="${item.damageImage || ''}">
        Tahrirlash
      </button>
      <button class="deleteDemageBtn" data-id="${item._id}">O‘chirish</button>
    `;
    container.appendChild(card);
  });
}// Qo‘shish tugmasi


// Modal ochish
function openDemageModal(id) {
  document.getElementById(id).style.display = 'flex';
}

// Modal yopish
function closeDemageModal(id) {
  document.getElementById(id).style.display = 'none';
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', () => {
 

  // Qo‘shish tugmasi
  document.getElementById('demageAddBtn').onclick = () => {
    document.getElementById('demagePostForm').reset();
    openDemageModal('demagePostModal');
  };

  // Yopish tugmalari
  document.getElementById('demagePostClose').onclick = () => closeDemageModal('demagePostModal');
  document.getElementById('demagePutClose').onclick = () => closeDemageModal('demagePutModal');

  // Qo‘shish formasi
  document.getElementById('demagePostForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
      const res = await fetch(`/api/cars/${selectedCarId}/damage-history`, {
        method: 'POST',
        body: formData
      });
      const json = await res.json();
      if (json.success) {
        closeDemageModal('demagePostModal');
        loadCarDetails(selectedCarId)
      }
    } catch (err) {
      console.error(err);
    }
  };

  // Kartalar ichidagi tugmalar
  document.getElementById('demageCardsContainer').onclick = async (e) => {
    if (e.target.classList.contains('editDemageBtn')) {
      const dataset = e.target.dataset;
    document.getElementById('demagePutId').value       = dataset.id;
    document.getElementById('demagePutDate').value     = dataset.date;
    document.getElementById('demagePutType').value     = dataset.type;
    document.getElementById('demagePutDaraja').value   = dataset.daraja;
    document.getElementById('demagePutLocation').value = dataset.location;
    document.getElementById('demagePutQatnashchi').value = dataset.qatnashchi;
    document.getElementById('demagePutRemont').value   = dataset.remont;
    document.getElementById('demagePutKuzup').value    = dataset.kuzup;

    // Agar rasm bo‘lsa, preview ko‘rsatish (ixtiyoriy)
    const previewEl = document.getElementById('demagePutImagePreview');
    if (previewEl) {
      previewEl.innerHTML = dataset.image 
        ? `<img src="${dataset.image}" alt="Old rasm" style="max-width:200px; margin-top:10px;">`
        : 'Hozircha rasm yo‘q';
    }
      openDemageModal('demagePutModal');
    }

    if (e.target.classList.contains('deleteDemageBtn')) {
      if (!confirm('O‘chirasizmi?')) return;
      const id = e.target.dataset.id;
      try {
        await fetch(`/api/cars/${selectedCarId}/damage-history/${id}`, { method: 'DELETE' });
       loadCarDetails(selectedCarId)
      } catch (err) {
        console.error(err);
      }
    }
  };
});
// PUT formasi submit (yangilash)
document.getElementById('demagePutForm').addEventListener('submit', async function(e) {
  e.preventDefault();

 var formData=new FormData(this)
  const id = document.querySelector('#demagePutId').value

  if (!id) {
    alert("Xatolik: ID topilmadi!");
    return;
  }

  try {
    const response = await fetch(`/api/cars/${selectedCarId}/damage-history/${id}`, {
      method: 'PUT',
      body: formData  // rasm fayli ham shu orqali yuboriladi
    });

    const json = await response.json();

    if (json.success) {
      closeDemageModal('demagePutModal');
      loadCarDetails(selectedCarId) // ro'yxatni yangilash funksiyasi (sizda bor deb hisoblaymiz)
      alert('Ma\'lumotlar yangilandi!');
    } else {
      alert('Yangilashda xato: ' + (json.message || 'Noma\'lum xato'));
    }
  } catch (err) {
    console.error('PUT xatosi:', err);
    alert('Server bilan aloqa xatosi');
  }
});


function renderDiagnosticCards(data) {
  const container = document.getElementById('diagnosticCardsContainer');
  container.innerHTML = '';

  if (!data.length) {
    container.innerHTML = '<p>Hozircha diagnostika yo‘q</p>';
    return;
  }

  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'sub-section_diagnostic_card sub-section_demage_card';
    card.innerHTML = `
      <div  >${new Date(item.inspectionDate).toLocaleDateString('uz-UZ')}</div>
      <p><strong>Manba:</strong> ${item.source}</p>
      <p><strong>Probeg:</strong> ${item.mileage} km</p>
      <p><strong>Hudud:</strong> ${item.region}</p>
      <button class="editDiagnosticBtn" 
        data-id="${item._id}"
        data-date="${new Date(item.inspectionDate).toISOString().split('T')[0]}"
        data-source="${item.source}"
        data-mileage="${item.mileage}"
        data-region="${item.region}">
        Tahrirlash
      </button>
      <button class="deleteDiagnosticBtn" data-id="${item._id}">O‘chirish</button>
    `;
    container.appendChild(card);
  });
}

// Modal ochish/yopish
function openDiagnosticModal(id) {
  document.getElementById(id).style.display = 'flex';
}

function closeDiagnosticModal(id) {
  document.getElementById(id).style.display = 'none';
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', () => {
 

  // Qo‘shish tugmasi
  document.getElementById('diagnosticAddBtn').onclick = () => {
    document.getElementById('diagnosticPostForm').reset();
    openDiagnosticModal('diagnosticPostModal');
  };

  // Yopish
  document.getElementById('diagnosticPostClose').onclick = () => closeDiagnosticModal('diagnosticPostModal');
  document.getElementById('diagnosticPutClose').onclick = () => closeDiagnosticModal('diagnosticPutModal');

  // Qo‘shish formasi
  document.getElementById('diagnosticPostForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    try {
      const res = await fetch(`/api/cars/${selectedCarId}/diagnostic-history`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (json.success) {
        closeDiagnosticModal('diagnosticPostModal');
        loadCarDetails(selectedCarId);
      }
    } catch (err) {
      console.error(err);
    }
  };

  // Kartalar delegatsiyasi
  document.getElementById('diagnosticCardsContainer').onclick = async (e) => {
    const t = e.target;

    if (t.classList.contains('editDiagnosticBtn')) {
      const d = t.dataset;
      document.getElementById('diagnosticPutId').value = d.id;
      document.getElementById('diagnosticPutDate').value = d.date;
      document.getElementById('diagnosticPutSource').value = d.source;
      document.getElementById('diagnosticPutMileage').value = d.mileage;
      document.getElementById('diagnosticPutRegion').value = d.region;

      openDiagnosticModal('diagnosticPutModal');
    }

    if (t.classList.contains('deleteDiagnosticBtn')) {
      if (!confirm('O‘chirasizmi?')) return;
      const id = t.dataset.id;
      try {
        await fetch(`/api/cars/${selectedCarId}/diagnostic-history/${id}`, { method: 'DELETE' });
        loadCarDetails(selectedCarId);
      } catch (err) {
        console.error(err);
      }
    }
  };

  // PUT formasi
  document.getElementById('diagnosticPutForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const id = document.getElementById('diagnosticPutId').value;
    const data = Object.fromEntries(formData);

    try {
      const res = await fetch(`/api/cars/${selectedCarId}/diagnostic-history/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (json.success) {
        closeDiagnosticModal('diagnosticPutModal');
        loadCarDetails(selectedCarId);
      }
    } catch (err) {
      console.error(err);
    }
  };
});



// Kartalarni chiqarish
function auctionRenderCards(data) {
  const container = document.getElementById('auctionCardsContainer');
  container.innerHTML = '';

  if (!data.length) {
    container.innerHTML = '<p>Hozircha auction yo‘q</p>';
    return;
  }

  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'auction-card';
    card.innerHTML = `
      <div class="auction-card__image">
        <img src="${item.image}" alt="Auction rasmi">
      </div>
      <div class="auction-card__link">
        <a href="${item.link}" target="_blank">Havolaga o‘tish</a>
      </div>
      <div class="auction-card__actions">
        <button class="auction-btn auction-btn--edit" 
          data-id="${item._id}"
          data-image="${item.image}"
          data-link="${item.link}">
          Tahrirlash
        </button>
        <button class="auction-btn auction-btn--delete" data-id="${item._id}">O‘chirish</button>
      </div>
    `;
    container.appendChild(card);
  });
}

// Modal ochish/yopish
function auctionOpenModal(id) {
  document.getElementById(id).style.display = 'flex';
}

function auctionCloseModal(id) {
  document.getElementById(id).style.display = 'none';
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', () => {
 

  document.getElementById('auctionAddBtn').onclick = () => {
    document.getElementById('auctionPostForm').reset();
    auctionOpenModal('auctionPostModal');
  };

  document.getElementById('auctionPostClose').onclick = () => auctionCloseModal('auctionPostModal');
  document.getElementById('auctionPutClose').onclick = () => auctionCloseModal('auctionPutModal');

  // Qo‘shish
  document.getElementById('auctionPostForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
      const res = await fetch(`/api/cars/${selectedCarId}/auction-history`, {
        method: 'POST',
        body: formData
      });
      const json = await res.json();
      if (json.success) {
        auctionCloseModal('auctionPostModal');
        loadCarDetails(selectedCarId);
      }
    } catch (err) {
      console.error(err);
    }
  };

  // Kartalar delegatsiyasi
  document.getElementById('auctionCardsContainer').onclick = async (e) => {
    const t = e.target;

    if (t.classList.contains('auction-btn--edit')) {
      const d = t.dataset;
      document.getElementById('auctionPutId').value = d.id;
      document.getElementById('auctionPutLink').value = d.link;

      // Oldingi rasm preview
      const preview = document.getElementById('auctionPutImagePreview');
      if (preview) {
        preview.innerHTML = d.image ? `<img src="${d.image}" style="max-width:200px;">` : 'Hozircha rasm yo‘q';
      }

      auctionOpenModal('auctionPutModal');
    }

    if (t.classList.contains('auction-btn--delete')) {
      if (!confirm('O‘chirasizmi?')) return;
      const id = t.dataset.id;
      try {
        await fetch(`/api/cars/${selectedCarId}/auction-history/${id}`, { method: 'DELETE' });
        loadCarDetails(selectedCarId);
      } catch (err) {
        console.error(err);
      }
    }
  };

  // PUT formasi
  document.getElementById('auctionPutForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const id = document.getElementById('auctionPutId').value;

    try {
      const res = await fetch(`/api/cars/${selectedCarId}/auction-history/${id}`, {
        method: 'PUT',
        body: formData
      });
      const json = await res.json();
      if (json.success) {
        auctionCloseModal('auctionPutModal');
        loadCarDetails(selectedCarId);
      }
    } catch (err) {
      console.error(err);
    }
  };
});






var selectedCarId2

// Yuridik modalni ochish va ma'lumotlarni yuklash
function openYuridikModal(carId) {
  // Modalni ochish
  selectedCarId2=carId
  loadYuridikEvents2(carId)
  document.getElementById('yuridik-modal').style.display = 'flex';
  
  // Mashina ma'lumotlarini olish va render qilish
  fetch(`/api/cars/${carId}`)
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        const car = result.data;
        
        // Har bir array uchun render qilish
        renderYuridikList('lizing-list', car.LizingHistory || [], 'Lizing', carId);
        renderYuridikList('sud-list',     car.SudHistory     || [], 'Sud',    carId);
        renderYuridikList('qidiruv-list', car.QidiruvHistory || [], 'Qidiruv', carId);
        renderYuridikList('zalog-list',   car.ZalogHistory   || [], 'Zalog',  carId);
      } else {
        alert('Mashina ma\'lumotlari topilmadi');
      }
    })
    .catch(err => {
      console.error(err);
      alert('Ma\'lumot yuklashda xato');
    });
}

// Har bir bo‘lim uchun kartalarni chiqarish
function renderYuridikList(containerId, items, type, carId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  if (items.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#64748b;">Hozircha ma\'lumot yo‘q</p>';
    return;
  }

  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'yuridik-card';
    card.innerHTML = `
      <h5>${item.title || 'Sarlavha kiritilmagan'}</h5>
      <p>${item.text || 'Matn kiritilmagan'}</p>
      <div class="yuridik-actions">
        <button class="yuridik-edit-btn" onclick="editYuridikItem('${selectedCarId2}', '${type}', '${item._id}')">
          Tahrirlash
        </button>
        <button class="yuridik-delete-btn" onclick="deleteYuridikItem('${selectedCarId2}', '${type}', '${item._id}')">
          O‘chirish
        </button>
      </div>
    `;
    container.appendChild(card);
  });
}

// Qo‘shish modalini ochish (har bir tur uchun)
function openAddYuridik(type) {
  // Bu yerda yangi modal ochilishi mumkin (hozircha prompt bilan misol)
  const title = prompt(`${type} uchun sarlavha:`);
  const text = prompt(`${type} uchun matn:`);
  
  if (!title || !text) return;

  const payload = { title, text };

  fetch(`/api/cars/${selectedCarId2}/${type.toLowerCase()}-history`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      openYuridikModal(selectedCarId2); // modalni yangilash
      alert('Muvaffaqiyatli qo‘shildi!');
    }
  })
  .catch(err => console.error(err));
}

// Tahrirlash (prompt bilan misol)
function editYuridikItem(carId, type, id) {
  const title = prompt(`Yangi sarlavha (${type}):`);
  const text = prompt(`Yangi matn (${type}):`);

  if (!title || !text) return;

  fetch(`/api/cars/${selectedCarId2}/${type.toLowerCase()}-history/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, text })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      openYuridikModal(selectedCarId2);
      alert('Yangilandi!');
    }
  });
}

// O‘chirish
function deleteYuridikItem(carId, type, id) {
  if (!confirm(`O‘chirishni tasdiqlaysizmi? (${type})`)) return;

  fetch(`/api/cars/${selectedCarId2}/${type.toLowerCase()}-history/${id}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      openYuridikModal(selectedCarId2);
      alert('O‘chirildi!');
    }
  });
}
// Modal ochish
function openEventModal(type, mode, eventData = null) {
    console.log(eventData);
  const modal = document.getElementById('eventModal');
  const form = document.getElementById('eventForm');
  const titleEl = document.getElementById('eventModalTitle');
  const typeInput = document.getElementById('eventType');

  typeInput.value = type; // history yoki shtraf

  if (mode === 'add') {
    titleEl.textContent = type === 'history' ? 'Yangi voqea qo‘shish' : 'Yangi jarima qo‘shish';
    form.reset();
    document.getElementById('eventId').value = '';
    document.getElementById('eventImagePreview').innerHTML = '';
  } else if (mode === 'edit' && eventData) {
    titleEl.textContent = type === 'history' ? 'Voqeani tahrirlash' : 'Jarimani tahrirlash';
  
    
    document.getElementById('eventId').value = eventData.events[0]._id;
    document.getElementById('eventDate').value = new Date(eventData.date).toISOString().split('T')[0];
    document.getElementById('eventTitle').value = eventData.events[0].title || '';
    document.getElementById('eventText').value = eventData.events[0].text || '';
    
    // Oldingi rasm preview
    const preview = document.getElementById('eventImagePreview');
    preview.innerHTML = eventData.events[0].image 
      ? `<img src="${eventData.events[0].image}" style="max-width:220px; border-radius:8px; margin-top:10px;">`
      : '<small>Hozircha rasm yo‘q</small>';
  }

  modal.style.display = 'flex';
}

// Modal yopish
function closeEventModal() {
  document.getElementById('eventModal').style.display = 'none';
  document.getElementById('eventForm').reset();
}

// Forma yuborish (qo‘shish yoki yangilash)
document.getElementById('eventForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);
  const type = document.getElementById('eventType').value;
  const id = document.getElementById('eventId').value;
  const url = id 
    ? `/api/cars/${selectedCarId2}/${type}-events/${id}`
    : `/api/cars/${selectedCarId2}/${type}-events`;

  try {
    const res = await fetch(url, {
      method: id ? 'PUT' : 'POST',
      body: formData
    });

    const json = await res.json();

    if (json.success) {
      closeEventModal();
      loadYuridikEvents2(selectedCarId2); // yuridik modalni yangilash
      alert(id ? 'Yangilandi!' : 'Qo‘shildi!');
    } else {
      alert(json.message || 'Xato yuz berdi');
    }
  } catch (err) {
    alert('Server xatosi');
  }
});

function editEvent(id, type, eventJsonStr) {
  try {
    const event = JSON.parse(decodeURIComponent(eventJsonStr));
    console.log("Qayta tiklangan event:", event);
    openEventModal(type, 'edit', event);
  } catch (e) {
    console.error("JSON parse xatosi:", e);
    alert("Ma'lumotni qayta tiklashda xato");
  }
}
function loadYuridikEvents2(carId) {
  fetch(`/api/cars/${carId}`)
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        const car = result.data;

        // History Events (Voqealar tarixi) — guruhlangan holda
        renderGuruhlanganEvents(
          'historyEventsAccordion',
          car.historyEvents || [],
          'history',
          'Voqealar tarixi'
        );

        // Shtraf Events (Jarima hodisalari) — guruhlangan holda
        renderGuruhlanganEvents(
          'shtrafEventsAccordion',
          car.shtrafEvents || [],
          'shtraf',
          'Jarima / shtraf hodisalari'
        );
      } else {
        console.warn("Mashina ma'lumotlari yuklanmadi");
      }
    })
    .catch(err => {
      console.error("Yuridik events yuklash xatosi:", err);
    });
}

// Guruhlangan hodisalarni chiqarish funksiyasi (accordion uslubida)
function renderGuruhlanganEvents(containerId, items, type, sectionTitle) {
  const container = document.getElementById(containerId);
  if (!container) {
    console.error(`Container topilmadi: #${containerId}`);
    return;
  }

  // Debugging: kelgan ma'lumotni konsolga chiqarish
  console.log(`renderGuruhlanganEvents chaqirildi → containerId: ${containerId}, type: ${type}`);
  console.log("Kelgan items:", items);

  container.innerHTML = '';

  // Agar items massiv emas yoki bo‘sh bo‘lsa
  if (!Array.isArray(items) || items.length === 0) {
    container.innerHTML = `<p style="text-align:center; color:#64748b; padding:20px;">
      Hozircha ${sectionTitle.toLowerCase()} yo‘q
    </p>`;
    return;
  }



  // Agar hech qanday guruh hosil bo‘lmasa
  if (Object.keys(items).length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#dc2626;">Ma\'lumotlar noto‘g‘ri formatda</p>';
    return;
  }

  // Eng yangi sanadan boshlab chiqarish
  Object.keys(items)
    .sort((a, b) => new Date(b) - new Date(a))
    .forEach(dateKey => {
      const item = items[dateKey];

      const groupDiv = document.createElement('div');
      groupDiv.className = 'accordion-group';

      // Header
      groupDiv.innerHTML = `
        <div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('show')">
          <span>${formatDate(item.date)}</span>
          <span style="font-size:1.1rem;">▼</span>
        </div>
        <div class="accordion-content">
          ${item.events.map(event1 => `
            <div class="yuridik-card" data-event-id="${event1._id || ''}">
              ${event1.image ? `
                <img  src="${event1.image}" 
                     alt="rasm" 
                     style="max-width:250px; border-radius:8px; margin:10px 0; display:block;"
                     onerror="this.src='/uploads/images.webp';">
              ` : ''}
              <h5 onclick="console.log(JSON.stringify(${event1}})" >${event1.title || 'Sarlavha kiritilmagan'}</h5>
              <p>${event1.text || 'Matn kiritilmagan'}</p>
              <small style="color:#6b7280;">
                ${event1.createdAt ? new Date(event1.createdAt).toLocaleString('uz-UZ') : 'Sana yo‘q'}
              </small>
              <div class="yuridik-actions">
                <button onclick="editEvent('${event1._id || ''}', '${type}','${encodeURIComponent(JSON.stringify(item))}')">Tahrirlash</button>
                <button onclick="deleteEvent('${event1._id || ''}', '${type}')">O‘chirish</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      container.appendChild(groupDiv);
    });
}

// Sana formatlash funksiyasi (agar yo‘q bo‘lsa qo‘shing)
function formatDate(dateStr) {
  if (!dateStr) return "Sana kiritilmagan";
  try {
    return new Date(dateStr).toLocaleDateString('uz-UZ', {
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    });
  } catch (e) {
    return "Noto‘g‘ri sana";
  }
}
// O‘chirish
function deleteEvent(id, type) {
  if (!confirm('Rostan o‘chirasizmi?')) return;

  fetch(`/api/cars/${selectedCarId2}/${type}-events/${id}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(json => {
    if (json.success) {
      loadYuridikEvents2(selectedCarId2);
      alert('O‘chirildi!');
    } else {
      alert(json.message || 'Xato');
    }
  });
}
    // Dastlabki yuklashlar
    fetchCarousels();
    loadFeatures();
    loadRisks();
  </script>
</body>

</html>