<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .probeg {
    background: #fff;
    border-radius: 16px;
    padding: 24px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.probeg .top {
    margin-bottom: 30px;
}

.probeg .top .left {
    width: 100%;
}

.probeg h3 {
    font-size: 16px;
    font-weight: 400;
    color: #666;
    margin: 0 0 12px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.probeg .status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 500;
}

.probeg .status-red {
    color: #ff5252;
}

.probeg .status-green {
    color: #4caf50;
}

.probeg .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.probeg .status-red .status-dot {
    background: #ff5252;
}

.probeg .status-green .status-dot {
    background: #4caf50;
}

.probeg h2 {
    font-size: 32px;
    font-weight: 600;
    color: #000;
    margin: 0 0 8px 0;
}

.probeg .top p {
    font-size: 14px;
    color: #999;
    margin: 0;
    line-height: 1.5;
}

.probeg .chart {
    position: relative;
    padding-left: 40px;
}

/* Y-axis labels */
.y-axis-labels {
    position: absolute;
    left: 0;
    top: 0;
    height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 12px 0;
}

.y-axis-labels span {
    font-size: 13px;
    color: #999;
    line-height: 1;
}

/* SVG */
.probeg .chart svg {
    display: block;
}

/* Years */
.probeg .chart .years {
    display: flex;
    justify-content: space-between;
    padding: 15px 0 0 0;
    margin-left: -5px;
}

.probeg .chart .years span {
    font-size: 14px;
    color: #999;
    flex: 1;
    text-align: center;
}

.probeg .chart .years span:first-child {
    text-align: left;
}

.probeg .chart .years span:last-child {
    text-align: right;
}

/* Footer with switch */
.probeg .chart .footer {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-top: 20px;
}

.probeg .footer-text {
    font-size: 14px;
    color: #666;
}

.probeg .info-icon {
    margin-left: 4px;
    cursor: pointer;
}

/* Toggle Switch */
.switch-container {
    position: relative;
    display: inline-block;
    width: 42px;
    height: 24px;
    cursor: pointer;
}

.switch-input {
    opacity: 0;
    width: 0;
    height: 0;
}

.switch-slider {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #2196F3;
    border-radius: 24px;
    transition: 0.3s;
}

.switch-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: 0.3s;
}

.switch-input:checked + .switch-slider {
    background-color: #2196F3;
}

.switch-input:checked + .switch-slider:before {
    transform: translateX(18px);
}

.switch-input:not(:checked) + .switch-slider {
    background-color: #ccc;
}

/* Chart points hover */
.probeg .chart svg circle {
    cursor: pointer;
    transition: all 0.2s ease;
}

.probeg .chart svg circle:hover {
    r: 9;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

/* Tooltip */
.chart-tooltip {
    position: absolute;
    background: #fff;
    border: 2px solid #e0e0e0;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    pointer-events: none;
    z-index: 1000;
    display: none;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.chart-tooltip::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid #e0e0e0;
}

.chart-tooltip::before {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 7px solid #fff;
    z-index: 1;
}

/* Responsive */
@media (max-width: 768px) {
    .probeg {
        padding: 16px;
    }
    
    .probeg h2 {
        font-size: 26px;
    }
    
    .probeg .chart {
        padding-left: 30px;
    }
    
    .y-axis-labels span {
        font-size: 11px;
    }
}
    </style>
</head>
<body>
    <section class="probeg">
    <div class="top">
        <div class="left">
            <h3>
                По нашим данным 
                <div class="status status-red">
                    Похоже, скручен <span class="status-dot"></span>
                </div>
            </h3>
            <h2>от 93 000 км</h2>
            <p>Он нужен для заключения договора купли-продажи и регистрации автомобиля</p>
        </div>
    </div>

    <div class="chart">
        <!-- Y-axis labels -->
        <div class="y-axis-labels">
            <span>93</span>
            <span>75</span>
            <span>60</span>
            <span>45</span>
            <span>30</span>
            <span>15</span>
            <span>0</span>
        </div>

        <!-- SVG GRAPH -->
        <svg viewBox="0 0 1000 300" width="100%" height="300" preserveAspectRatio="none">
            <!-- GRID -->
            <g stroke="#f0f0f0" stroke-width="1">
                <line x1="0" y1="20" x2="1000" y2="20" />
                <line x1="0" y1="65" x2="1000" y2="65" />
                <line x1="0" y1="110" x2="1000" y2="110" />
                <line x1="0" y1="155" x2="1000" y2="155" />
                <line x1="0" y1="200" x2="1000" y2="200" />
                <line x1="0" y1="245" x2="1000" y2="245" />
                <line x1="0" y1="290" x2="1000" y2="290" />
            </g>

            <!-- POINTS GROUP -->
            <g></g>
        </svg>

        <div class="years">
            <span>2020</span>
            <span>2022</span>
            <span>2023</span>
            <span>2024</span>
            <span>2025</span>
        </div>

        <div class="footer">
            <label class="switch-container">
                <input type="checkbox" class="switch-input" checked>
                <span class="switch-slider"></span>
            </label>
            <span class="footer-text">Повторы и аномальные события</span>
            <svg class="info-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="8" cy="8" r="7" stroke="#999" stroke-width="1.5" fill="none"/>
                <text x="8" y="11" text-anchor="middle" font-size="11" font-weight="600" fill="#999">i</text>
            </svg>
        </div>
    </div>
    <script>
       // API dan ma'lumot olish
async function loadCarData(searchQuery) {
  try {
    const response = await fetch(`/api/cars/search?q=${searchQuery}`);
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      const car = result.data[0];
      
      console.log('Car data:', car);
      
      // Probeg diagrammasini chizish
      if (car.probegHistory && car.probegHistory.length > 0) {
        renderProbegChart(car.probegHistory);
      }
      
      // Exploitation History ni ko'rsatish
      if (car.exploitationHistory && car.exploitationHistory.length > 0) {
        renderExploitationHistory(car.exploitationHistory);
      }
      
      // Boshqa ma'lumotlarni ham ko'rsatish mumkin
      // renderCarInfo(car);
      // renderFeatures(car.features);
      // renderLegalRisks(car.legalRisks);
      
    } else {
      console.log('Mashina topilmadi');
      showNoDataMessage();
    }
  } catch (error) {
    console.error('Ma\'lumot yuklashda xatolik:', error);
    showErrorMessage(error);
  }
}

// Ma'lumot topilmasa
function showNoDataMessage() {
  const probegSection = document.querySelector('.probeg');
  const istoriyaSection = document.querySelector('.istoriya');
  
  if (probegSection) {
    probegSection.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Данные не найдены</p>';
  }
  
  if (istoriyaSection) {
    const timeline = istoriyaSection.querySelector('.istoriya_timeline');
    if (timeline) {
      timeline.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">История не найдена</p>';
    }
  }
}

// Xatolik yuz bersa
function showErrorMessage(error) {
  console.error('Xatolik:', error);
  const probegSection = document.querySelector('.probeg');
  
  if (probegSection) {
    probegSection.innerHTML = '<p style="text-align: center; padding: 40px; color: #ff5252;">Ошибка загрузки данных</p>';
  }
}

// Probeg diagrammasini chizish
function renderProbegChart(probegHistory) {
  // Year bo'yicha sort qilish
  const sortedData = [...probegHistory].sort((a, b) => a.year - b.year);
  
  if (sortedData.length === 0) return;

  // Min/max hisoblash
  const minKm = Math.min(...sortedData.map(p => p.kilometer));
  const maxKm = Math.max(...sortedData.map(p => p.kilometer));
  const kmRange = maxKm - minKm || 1;

  // Koordinatalarni hisoblash
  const svgWidth = 1000;
  const svgTop = 20;
  const svgBottom = 290;
  const svgHeight = svgBottom - svgTop;
  const padding = 20;
  const xStep = (svgWidth - padding * 2) / (sortedData.length - 1 || 1);
  
  let points = [];
  let circles = [];
  let years = [];
  
  sortedData.forEach((item, index) => {
    const x = padding + (index * xStep);
    const y = svgBottom - ((item.kilometer - minKm) / kmRange) * svgHeight;
    
    points.push(`${x},${y}`);
    circles.push({ x, y, km: item.kilometer, year: item.year });
    years.push(item.year);
  });

  // SVG ni yangilash
  const svg = document.querySelector('.probeg .chart svg');
  
  // Eski polyline va circlelarni o'chirish
  const oldPolylines = svg.querySelectorAll('polyline');
  oldPolylines.forEach(p => p.remove());
  
  const circlesGroup = svg.querySelector('g:last-child');
  circlesGroup.innerHTML = '';

  // Grid dan keyin yangi elementlar qo'shish
  const gridGroup = svg.querySelector('g');
  
  // Har bir segment uchun chiziq va nuqta chizish
  for (let i = 0; i < circles.length - 1; i++) {
    const currentKm = sortedData[i].kilometer;
    const nextKm = sortedData[i + 1].kilometer;
    
    // Segment koordinatalari
    const segmentPoints = `${circles[i].x},${circles[i].y} ${circles[i + 1].x},${circles[i + 1].y}`;
    
    // Ko'tarilish (ko'k) yoki tushish (qizil)
    const isIncreasing = nextKm > currentKm;
    const color = isIncreasing ? '#2196F3' : '#ff5252'; // Ko'k yoki qizil
    
    // Polyline yaratish
    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
    polyline.setAttribute('points', segmentPoints);
    polyline.setAttribute('fill', 'none');
    polyline.setAttribute('stroke', color);
    polyline.setAttribute('stroke-width', '2.5');
    polyline.setAttribute('stroke-linejoin', 'round');
    polyline.setAttribute('stroke-linecap', 'round');
    
    svg.insertBefore(polyline, circlesGroup);
  }

  // Circlelarni qo'shish
  circles.forEach((c, i) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', c.x);
    circle.setAttribute('cy', c.y);
    circle.setAttribute('r', '7');
    circle.setAttribute('data-km', c.km);
    circle.setAttribute('data-year', c.year);
    circle.classList.add('chart-point');
    
    // Birinchi nuqta
    if (i === 0) {
      circle.setAttribute('fill', '#fff');
      circle.setAttribute('stroke', '#2196F3');
      circle.setAttribute('stroke-width', '2.5');
    } 
    // Oxirgi nuqta
    else if (i === circles.length - 1) {
      const prevKm = sortedData[i - 1].kilometer;
      const currKm = sortedData[i].kilometer;
      const color = currKm > prevKm ? '#2196F3' : '#ff5252';
      
      circle.setAttribute('fill', '#fff');
      circle.setAttribute('stroke', color);
      circle.setAttribute('stroke-width', '2.5');
    }
    // O'rtadagi nuqtalar
    else {
      const prevKm = sortedData[i - 1].kilometer;
      const currKm = sortedData[i].kilometer;
      const nextKm = sortedData[i + 1].kilometer;
      
      // Agar kamayish bo'lsa - to'liq qizil
      if (currKm < prevKm) {
        circle.setAttribute('fill', '#ff5252');
      } 
      // Agar keyingi kamayish bo'lsa - qizil border
      else if (nextKm < currKm) {
        circle.setAttribute('fill', '#fff');
        circle.setAttribute('stroke', '#ff5252');
        circle.setAttribute('stroke-width', '2.5');
      }
      // Aks holda ko'k
      else {
        circle.setAttribute('fill', '#fff');
        circle.setAttribute('stroke', '#2196F3');
        circle.setAttribute('stroke-width', '2.5');
      }
    }
    
    circlesGroup.appendChild(circle);
  });

  // Y-axis labellarini yangilash
  updateYAxisLabels(minKm, maxKm);

  // Yillar
  const yearsDiv = document.querySelector('.probeg .chart .years');
  yearsDiv.innerHTML = years.map(y => `<span>${y}</span>`).join('');

  // Status
  const statusDiv = document.querySelector('.probeg .status');
  const hasAnomaly = sortedData.some((item, i) => 
    i > 0 && item.kilometer < sortedData[i - 1].kilometer
  );

  if (hasAnomaly) {
    statusDiv.innerHTML = 'Похоже, скручен <span class="status-dot"></span>';
    statusDiv.className = 'status status-red';
  } else {
    statusDiv.innerHTML = 'Нормальный <span class="status-dot"></span>';
    statusDiv.className = 'status status-green';
  }

  // Kilometr
  document.querySelector('.probeg h2').textContent = `от ${minKm.toLocaleString()} км`;

  // Tooltip
  setupTooltip();
}
// Y-axis labellarini yangilash
function updateYAxisLabels(minKm, maxKm) {
  const yAxisLabels = document.querySelector('.y-axis-labels');
  if (!yAxisLabels) return;

  const step = Math.ceil((maxKm - minKm) / 6);
  const labels = [];
  
  for (let i = 6; i >= 0; i--) {
    const value = Math.round((minKm + (step * i)) / 1000);
    labels.push(value);
  }

  yAxisLabels.innerHTML = labels.map(l => `<span>${l}</span>`).join('');
}

// Exploitation History render
function renderExploitationHistory(exploitationHistory) {
  if (!exploitationHistory || exploitationHistory.length === 0) {
    console.log('Exploitation history topilmadi');
    return;
  }

  const sortedHistory = [...exploitationHistory].sort((a, b) => {
    return new Date(b.startDate) - new Date(a.startDate);
  });

  const timelineContainer = document.querySelector('.istoriya_timeline');
  
  if (!timelineContainer) {
    console.error('Timeline konteyner topilmadi');
    return;
  }

  timelineContainer.innerHTML = '';

  sortedHistory.forEach(item => {
    const itemDiv = createHistoryItem(item);
    timelineContainer.appendChild(itemDiv);
  });

  updateHistoryStats(sortedHistory);
  setupShowMoreButton();
}

// History item yaratish
function createHistoryItem(item) {
  const div = document.createElement('div');
  div.className = 'istoriya_item';

  const startDate = formatDate(item.startDate);
  const endDate = item.endDate ? formatDate(item.endDate) : 'Hozir';
  const dateRange = `${startDate} — ${endDate}`;

  let kmText = '';
  if (item.startKilometer && item.endKilometer) {
    kmText = `${item.startKilometer.toLocaleString()} → ${item.endKilometer.toLocaleString()} км`;
  } else if (item.endKilometer) {
    kmText = `${item.endKilometer.toLocaleString()} км`;
  } else if (item.startKilometer) {
    kmText = `${item.startKilometer.toLocaleString()} км`;
  }

  const isCommercial = item.title && (
    item.title.toLowerCase().includes('такси') || 
    item.title.toLowerCase().includes('коммерц') ||
    item.description.toLowerCase().includes('такси')
  );
  const commercialLabel = isCommercial ? ' (Коммерция)' : '';

  div.innerHTML = `
    <div class="istoriya_date">
      <span>${dateRange}${commercialLabel}</span><br>
      ${kmText ? `
        <div class="istoriya_km">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 0C9.06087 0 10.0783 0.421427 10.8284 1.17157C11.5786 1.92172 12 2.93913 12 4C12 5.06087 11.5786 6.07828 10.8284 6.82843C10.0783 7.57857 9.06087 8 8 8C6.93913 8 5.92172 7.57857 5.17157 6.82843C4.42143 6.07828 4 5.06087 4 4C4 2.93913 4.42143 1.92172 5.17157 1.17157C5.92172 0.421427 6.93913 0 8 0ZM8 10C12.42 10 16 11.79 16 14V16H0V14C0 11.79 3.58 10 8 10Z" fill="white" />
          </svg> 
          ${kmText}
        </div>
      ` : ''}
    </div>

    <div class="istoriya_line">
      <span class="istoriya_circle"></span>
    </div>

    <div class="istoriya_content">
      <div class="istoriya_date istoriya_date_2">
        <span>${dateRange}${commercialLabel}</span><br>
        ${kmText ? `
          <div class="istoriya_km">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 0C9.06087 0 10.0783 0.421427 10.8284 1.17157C11.5786 1.92172 12 2.93913 12 4C12 5.06087 11.5786 6.07828 10.8284 6.82843C10.0783 7.57857 9.06087 8 8 8C6.93913 8 5.92172 7.57857 5.17157 6.82843C4.42143 6.07828 4 5.06087 4 4C4 2.93913 4.42143 1.92172 5.17157 1.17157C5.92172 0.421427 6.93913 0 8 0ZM8 10C12.42 10 16 11.79 16 14V16H0V14C0 11.79 3.58 10 8 10Z" fill="white" />
            </svg> 
            ${kmText}
          </div>
        ` : ''}
      </div>
      <h3>${item.title || 'Без названия'}</h3>
      <p class="istoriya_subtitle">${item.description || ''}</p>
      <p class="istoriya_location">${item.location || ''}</p>
    </div>
  `;

  return div;
}

// Sanani formatlash
function formatDate(isoDate) {
  if (!isoDate) return '';
  
  const date = new Date(isoDate);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const day = date.getDate();

  if (day === 1) {
    return `${month}.${year}`;
  }
  
  return `${String(day).padStart(2, '0')}.${month}.${year}`;
}

// Statistikani yangilash
function updateHistoryStats(history) {
  const statsP = document.querySelector('.istoriya_card_top p');
  const commercialH6 = document.querySelector('.istoriya_card_top h6');

  if (statsP) {
    const totalEvents = history.length;
    statsP.textContent = `Найдено ${totalEvents} событий и 1 владелец`;
  }

  if (commercialH6) {
    const commercialCount = history.filter(item => 
      item.title && (
        item.title.toLowerCase().includes('такси') || 
        item.title.toLowerCase().includes('коммерц') ||
        item.description.toLowerCase().includes('такси')
      )
    ).length;

    if (commercialCount > 0) {
      commercialH6.innerHTML = `
        Коммерч. использование: ${commercialCount} записи
        <span class="istoriya_red_circle"></span>
      `;
      commercialH6.style.display = 'flex';
    } else {
      commercialH6.style.display = 'none';
    }
  }
}

// "Показать еще" tugmasi
function setupShowMoreButton() {
  const showMoreBtn = document.querySelector('.istoriya_title button');
  const timelineItems = document.querySelectorAll('.istoriya_item');

  if (!showMoreBtn || timelineItems.length === 0) return;

  const initialShowCount = 3;
  let currentShowCount = initialShowCount;

  timelineItems.forEach((item, index) => {
    if (index >= initialShowCount) {
      item.style.display = 'none';
    }
  });

  if (timelineItems.length <= initialShowCount) {
    showMoreBtn.style.display = 'none';
  }

  showMoreBtn.addEventListener('click', function() {
    currentShowCount += 3;

    timelineItems.forEach((item, index) => {
      if (index < currentShowCount) {
        item.style.display = 'flex';
      }
    });

    if (currentShowCount >= timelineItems.length) {
      showMoreBtn.style.display = 'none';
    }
  });
}

// Tooltip setup
function setupTooltip() {
  const chartDiv = document.querySelector('.probeg .chart');
  const svg = chartDiv.querySelector('svg');
  
  let tooltip = chartDiv.querySelector('.chart-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.className = 'chart-tooltip';
    chartDiv.appendChild(tooltip);
  }

  const circles = svg.querySelectorAll('.chart-point');
  
  circles.forEach(circle => {
    circle.style.cursor = 'pointer';
    
    circle.addEventListener('mouseenter', function(e) {
      const km = this.getAttribute('data-km');
      const year = this.getAttribute('data-year');
      
      tooltip.innerHTML = `
        <div style="font-size: 11px; color: #999; margin-bottom: 4px;">${year} год</div>
        <div style="font-size: 15px; font-weight: 600; color: #333;">${parseInt(km).toLocaleString()} км</div>
      `;
      
      const svgRect = svg.getBoundingClientRect();
      const cx = parseFloat(this.getAttribute('cx'));
      const cy = parseFloat(this.getAttribute('cy'));
      
      const svgWidth = svg.viewBox.baseVal.width;
      const svgHeight = svg.viewBox.baseVal.height;
      
      const xPos = (cx / svgWidth) * svgRect.width;
      const yPos = (cy / svgHeight) * svgRect.height;
      
      tooltip.style.display = 'block';
      tooltip.style.left = xPos + 'px';
      tooltip.style.top = (yPos - 70) + 'px';
      tooltip.style.transform = 'translateX(-50%)';
      
      this.setAttribute('r', '9');
    });

    circle.addEventListener('mouseleave', function() {
      tooltip.style.display = 'none';
      this.setAttribute('r', '7');
    });
  });
}
document.addEventListener('DOMContentLoaded', function () {
  const urlParams = new URLSearchParams(window.location.search);
  const gosNumber = urlParams.get('gosNumber');

  if (gosNumber) {
    loadCarData(gosNumber);
  }
});

    </script>
</section>
</body>
</html>